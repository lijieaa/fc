<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <style>
        .btn, .border-none {
            border: 1px solid #6FB3E0;
        }
    </style>
</head>
<body layout:fragment="content">
<div class="row" id="association" v-cloak>
    <div class="page-header">
        <div class="row">
            <div class="col-md-9 col-sm-9">
                <div class="float-left">
                    <span class="font-size-18 border-left-blue">项目关联</span>
                </div>
            </div>
            <div class="col-md-3 col-sm-3 text-align-right">
                <button type="button" data-toggle="modal" id="backList" class="btn btn-info padding-right-15">
                    <i class="ace-icon fa fa-reply icon-only"></i>
                    返回
                </button>
            </div>
        </div>
    </div>
    <div class="col-xs-12">
        <div class="row">
            <div class="col-xs-12 widget-container-col" id="widget-container-col-1">
                <div class="widget-box" id="widget-box-1">
                    <div class="widget-header">
                        <h5 class="widget-title">筛选</h5>

                        <div class="widget-toolbar">
                            <a href="#" data-action="collapse">
                                <i class="ace-icon fa fa-chevron-down"></i>
                            </a>
                        </div>
                    </div>

                    <div class="widget-body">
                        <div class="widget-main">
                            <form class="form-horizontal" id="search-form">
                                <div class="form-group col-xs-12 col-sm-6">
                                    <label class="control-label col-xs-12 col-sm-4 no-padding-right"
                                           for="num">生成编号:</label>
                                    <div class="col-xs-12 col-sm-8">
                                        <div class="clearfix">
                                            <input type="text" name="num" id="projectName" class="col-xs-12 col-sm-12" />
                                        </div>
                                    </div>
                                </div>
                                <div class="clearfix form-actions clearboth">
                                    <div class="col-md-offset-0 col-md-9">
                                        <button class="btn btn-info" type="button" id="search">
                                            <i class="ace-icon glyphicon glyphicon-search"></i>
                                            搜索
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="space-6"></div>
        <div class="row">
            <div class="col-xs-12">
                <div>
                    <table id="dynamic-table" class="table table-striped table-bordered table-hover">
                        <thead>
                        <tr>
                            <th class="center">
                                <label class="pos-rel">
                                    <input type="checkbox" class="ace"/>
                                    <span class="lbl"></span>
                                </label>
                            </th>
                            <th>生产编号</th>
                            <th>型号</th>
                        </tr>
                        </thead>
                        <tbody>
                        <td class=" center"><label class="pos-rel"><input type="checkbox" class="ace"><span class="lbl"></span> </label></td>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="clearfix form-actions" style="margin-top:0;">
            <div class="col-md-offset-3 col-md-9">
                <button type="submit" id="submit" @click="addNum" class="btn btn-info">
                    <i class="ace-icon fa fa-check bigger-110"></i>确认关联
                </button>
                &nbsp; &nbsp; &nbsp;
                <button type="reset" @click="resetNum" class="btn">
                    <i class="ace-icon fa fa-undo bigger-110"></i>
                    取消
                </button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" th:inline="javascript">


    jQuery(function ($) {
        var projectId  =window.location.href.split("=")[1];
        new Vue({
            el:"#association",
            data:{
                checked:true,
                dataList:[],
                tableList:[],
                idArr:[],
            },
            methods:{
                addNum:function(){
                    var _this = this;
                    _this.deviceProductionNum = [];
                    $("#dynamic-table td input[type=checkbox]").each(function(i,item){
                        if(item.checked == true){
                            _this.idArr.push($(item).attr("data-id"));
                        }
                    });
                    if(  _this.idArr.length == 0){
                        bootbox.alert("请选择生产编号");
                        return false;
                    }
                    var postData = {
                        projectId:projectId,
                        ids:_this.idArr
                    };
                    $.ajax({
                        url:contextPath+"api/device",
                        method:"put",
                        contentType: "application/json",
                        dataType : "json",
                        data:JSON.stringify(postData),
                        success:function(data){
                            if(data.status == 200){
                                window.location.href = contextPath +"project/projectAssociation?id="+projectId
                            }
                        }
                    })

                },
                resetNum:function(){
                    $("#dynamic-table td input[type=checkbox]").each(function(i,item){
                        item.checked = false;
                    });
                }
            }
        });
        $("#backList").click(function () {
            location.href=contextPath+"project/list";
        });
        //initiate dataTables plugin
        var myTable =$('#dynamic-table')
        //.wrap("<div class='dataTables_borderWrap' />")   //if you are applying horizontal scrolling (sScrollX)
            .DataTable({
                bAutoWidth: false,
                "language": {
                    "url": contextPath+"ace/assets/js/zh_CN.json"
                },
                'order': [],
                "ordering": true,
                "processing": true,
                'paging': true,
                "serverSide": true,
                'searching': false,
                "ajax": function (data, callback, settings) {
                    var formData = $("#search-form").serialize();
                    // console.log(formData);
                    var pageNum=data.start/data.length+1;
                    var pageSize=data.length;
                    var draw=data.draw;

                    var orderByClause="";
                    for(var i=0;i<data.order.length;i++){
                        var obj=data.order[i];
                        var col=obj.column;
                        var dir=obj.dir;
                        var pro = data.columns[col].data;
                        orderByClause+=pro+" "+dir+",";
                    }
                    orderByClause = orderByClause.substr(0,orderByClause.lastIndexOf(","));

                    var param="?pageNum="+pageNum+"&pageSize="+pageSize+"&"+formData+"&draw="+draw+"&od="+orderByClause;
                    $.ajax({
                        "url": contextPath+"api/device/freeDeviceList"+param,
                        "type": "get",
                        dataType:"json",
                        contentType:'application/json',
                        "success": function (json) {
                            if (json.status == 200) {
                                var data = {};
                                data.recordsTotal = json.content.recordsTotal;
                                data.recordsFiltered = json.content.recordsFiltered;
                                data.data = json.content.data;
                                callback(data);
                            }
                        },
                        "error": function (XMLHttpRequest, textStatus, errorThrown) {
                            // console.log(errorThrown);
                        }
                    });
                },
                "columns": [
                    {"data": "deviceId"},
                    {"data": "deviceProductionNum"},
                    {"data": "deviceType"}
                ],
                "columnDefs": [
                    {
                        "targets": 0,
                        'searchable': false,
                        'orderable': false,
                        "data": null,
                        "render": function (data, type, row) {
                            return '<label class="pos-rel"><input type="checkbox" class="ace" data-id='+data+'><span class="lbl"></span> </label>';
                        },
                        "className": "center"

                    },
                    {
                        "targets": 1,
                        "orderable": true,
                        "searchable": true,
                        "render": function (data, type, row) {
                            return '<td>' + data + '</td>';
                        }
                    }

                ],
                select: {
                    style: 'multi'
                }
            });

        $.fn.dataTable.Buttons.defaults.dom.container.className = 'dt-buttons btn-overlap btn-group btn-overlap';

        new $.fn.dataTable.Buttons(myTable, {
            buttons: [
                {
                    "extend": "colvis",
                    "text": "<i class='fa fa-filter bigger-110 blue'></i> <span class='hidden'>显示/隐藏 ?</span>",
                    "className": "btn btn-white btn-primary btn-bold",
                    columns: ':not(:first):not(:last)'
                },
                // {
                //     "extend": "copy",
                //     "text": "<i class='fa fa-copy bigger-110 pink'></i> <span class='hidden'>拷贝到剪切板</span>",
                //     "className": "btn btn-white btn-primary btn-bold"
                // },
                {
                    "extend": "csv",
                    "text": "<i class='fa fa-download bigger-110 blue'></i> <span class='hidden'>导出CVS</span>",
                    "className": "btn btn-white btn-primary btn-bold"
                },
                // {
                //     "extend": "excel",
                //     "text": "<i class='fa fa-file-excel-o bigger-110 green'></i> <span class='hidden'>导出Excel</span>",
                //     "className": "btn btn-white btn-primary btn-bold"
                // },
                // {
                //     "extend": "pdf",
                //     "text": "<i class='fa fa-file-pdf-o bigger-110 red'></i> <span class='hidden'>导出PDF</span>",
                //     "className": "btn btn-white btn-primary btn-bold"
                // },
                {
                    "extend": "print",
                    "text": "<i class='ace-icon glyphicon glyphicon-print blue'></i> <span class='hidden'>打印</span>",
                    "className": "btn btn-white btn-primary btn-bold",
                    autoPrint: false,
                    message: ''
                }
            ]
        });
        myTable.buttons().container().appendTo($('.tableTools-container'));

        //style the message box
        var defaultCopyAction = myTable.button(1).action();
        myTable.button(1).action(function (e, dt, button, config) {
            defaultCopyAction(e, dt, button, config);
            $('.dt-button-info').addClass('gritter-item-wrapper gritter-info gritter-center white');
        });


        var defaultColvisAction = myTable.button(0).action();
        myTable.button(0).action(function (e, dt, button, config) {

            defaultColvisAction(e, dt, button, config);


            if ($('.dt-button-collection > .dropdown-menu').length == 0) {
                $('.dt-button-collection')
                    .wrapInner('<ul class="dropdown-menu dropdown-light dropdown-caret dropdown-caret" />')
                    .find('a').attr('href', '#').wrap("<li />")
            }
            $('.dt-button-collection').appendTo('.tableTools-container .dt-buttons')
        });

        ////

        setTimeout(function () {
            $($('.tableTools-container')).find('a.dt-button').each(function () {
                var div = $(this).find(' > div').first();
                if (div.length == 1) div.tooltip({container: 'body', title: div.parent().text()});
                else $(this).tooltip({container: 'body', title: $(this).text()});
            });
        }, 500);


        myTable.on('select', function (e, dt, type, index) {
            if (type === 'row') {
                $(myTable.row(index).node()).find('input:checkbox').prop('checked', true);
            }
        });
        myTable.on('deselect', function (e, dt, type, index) {
            if (type === 'row') {
                $(myTable.row(index).node()).find('input:checkbox').prop('checked', false);
            }
        });


        /////////////////////////////////
        //table checkboxes
        $('th input[type=checkbox], td input[type=checkbox]').prop('checked', false);

        //select/deselect all rows according to table header checkbox
        $('#dynamic-table > thead > tr > th input[type=checkbox], #dynamic-table_wrapper input[type=checkbox]').eq(0).on('click', function () {
            var th_checked = this.checked;//checkbox inside "TH" table header

            $('#dynamic-table').find('tbody > tr').each(function () {
                var row = this;
                if (th_checked) myTable.row(row).select();
                else  myTable.row(row).deselect();
            });
        });

        //select/deselect a row when the checkbox is checked/unchecked
        $('#dynamic-table').on('click', 'td input[type=checkbox]', function () {
            var row = $(this).closest('tr').get(0);
            if (this.checked) myTable.row(row).deselect();
            else myTable.row(row).select();
        });


        $(document).on('click', '#dynamic-table .dropdown-toggle', function (e) {
            e.stopImmediatePropagation();
            e.stopPropagation();
            e.preventDefault();
        });




        $('[data-rel="tooltip"]').tooltip({placement: tooltip_placement});

        function tooltip_placement(context, source) {
            var $source = $(source);
            var $parent = $source.closest('table')
            var off1 = $parent.offset();
            var w1 = $parent.width();

            var off2 = $source.offset();

            if (parseInt(off2.left) < parseInt(off1.left) + parseInt(w1 / 2)) return 'right';
            return 'left';
        }

        [# sec:authorize="hasAuthority('project:delete')"]
        //单个删除
        $('#dynamic-table tbody').on( 'click', 'a.delete', function () {
            var id = $(this).attr('data-id');
            bootbox.confirm( {
                message: "您真的要删除?",
                buttons: {
                    confirm: {
                        label: '确定',
                        className: 'btn-success'
                    },
                    cancel: {
                        label: '取消',
                        className: 'btn-danger'
                    }
                },
                callback: function (result) {

                    if(result){
                        $.ajax({
                            url: contextPath+"api/project/?id="+id,
                            method: "delete",
                            success: function (data) {
                                if(data.status==200){
                                    myTable.draw();
                                }
                            },
                            error: function (data) {
                                //console.log(data);
                            }
                        })
                    }
                }
            });

        } );
        [/]
            [# sec:authorize="hasAuthority('project:delete')"]
        $("#batch-delete").on("click", function () {

            var rows = myTable.rows('.selected').data();

            if(rows.length<=0){
                bootbox.alert("请选择你要删除的线索?!");
                return;
            }
            bootbox.confirm( {
                message: "您真的要删除吗?",
                buttons: {
                    confirm: {
                        label: '确定',
                        className: 'btn-success'
                    },
                    cancel: {
                        label: '取消',
                        className: 'btn-danger'
                    }
                },
                callback: function (result) {
                    if(result){

                        var rows = myTable.rows('.selected').data();

                        var ids=[];

                        for(var i=0;i<rows.length;i++){
                            ids.push(rows[i].projectId);
                        }


                        $.ajax({
                            url: contextPath+"api/project/batch",
                            method : "delete" ,
                            data : JSON.stringify(ids),
                            contentType: "application/json",
                            dataType : "json",
                            success: function (data) {
                                if(data.status==200){
                                    myTable.draw();
                                }
                            },
                            error: function (data) {
                                // console.log(data);
                            }
                        })
                    }
                }
            });
        })
            [/]


        $("#search").on("click",function(e){
            myTable.draw();
        })
    })
</script>
</body>
</html>
