<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
    <head>
        <link rel="stylesheet" th:href="@{/dist/css/dingtalkuser.css}" />
    </head>
<body layout:fragment="content">
<div class="row">
    <div class="col-sm-12">
        <div class="tabbable">
            <ul class="nav nav-tabs" id="myTab">
                <li class="col-sm-6 active no-padding">
                    <a data-toggle="tab" href="#insidecontacts" aria-expanded="true">
                        <i class="green ace-icon fa fa-home bigger-120"></i>
                        内部通讯录管理
                    </a>
                </li>
                <li class="col-sm-6 no-padding">
                    <a data-toggle="tab" href="#outcontacts" aria-expanded="false">
                        <i class="green ace-icon fa fa-home bigger-120"></i>
                        外部联系人
                    </a>
                </li>
            </ul>

            <div class="tab-content border-none">
                <!-- 内部通讯录管理 -->
                <div id="insidecontacts" class="tab-pane fade active in background-white">
                    <div class="page-header">
                        <h1>通讯录管理</h1>
                    </div>
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="input-group">
                                <input type="text" class="form-control search-query" placeholder="输入关键字搜索">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-purple btn-sm">
                                        <span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
                                        搜索
                                    </button>
                                </span>
                            </div>
                            <div class="tabbable">
                                <ul class="nav nav-tabs padding-12 tab-color-blue background-blue" id="myTab4">
                                    <li class="active organization-menu">
                                        <a data-toggle="tab" href="#organization-menu" aria-expanded="true">组织架构</a>
                                    </li>
                                    <li class="role-menu">
                                        <a data-toggle="tab" href="#role-menu" aria-expanded="false">角色</a>
                                    </li>
                                </ul>

                                <div class="tab-content">
                                    <div id="organization-menu" class="tab-pane active">
                                        <ul id="organization-list"  class="ztree"></ul>
                                    </div>

                                    <div id="role-menu" class="tab-pane align-center">
                                        <p><button type="button" class="btn btn-white btn-default add-role-group">新增角色组</button><button type="button" class="btn btn-white btn-default add-role-person">新增角色</button></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <div class="row">
                                <div class="col-xs-12">
                                    <!-- 组织架构 -->
                                    <div class="widget-box widget-main organization-container">
                                        <h3 class="header smaller lighter blue margin-top-0">
                                            <span class="department-name"></span>
                                            <!--<small class="btn-warning padding-3">全员群</small>-->
                                            <button id="edit-department-btn" type="button" class="btn btn-white btn-sm btn-primary">设置</button>
                                        </h3>
                                        <!-- 下级部门 -->
                                        <div class="sub-department">
                                            <h4 class="pink">
                                                <i class="ace-icon fa fa-sitemap icon-animated-hand-pointer blue"></i>
                                                <a href="#modal-table" role="button" class="green" data-toggle="modal"> 下级部门</a>
                                            </h4>
                                            <div class="hr hr-18 dotted hr-double"></div>
                                            <div class="widget-header widget-header-flat">
                                                <h4 class="smaller">
                                                    <button id="add-sub-department-btn" class="btn btn-white btn-info btn-bold">
                                                        <i class="ace-icon glyphicon glyphicon-plus small bigger-120 blue"></i>
                                                        添加子部门
                                                    </button>
                                                    <button class="btn btn-white btn-info btn-bold sub-department-queue display-none">
                                                        <i class="ace-icon fa fa-bars small bigger-120 blue"></i>
                                                        调整顺序
                                                    </button>
                                                    <span class="sub-department-queue-save-cancel display-none">
                                                        <button type="button" class="btn btn-white btn-default save">
                                                            <i class="ace-icon fa fa-floppy-o bigger-120 blue"></i>保存
                                                        </button>
                                                        <button type="button" class="btn btn-white btn-default cancel">
                                                            <i class="ace-icon fa fa-times red2"></i>取消
                                                        </button>
                                                    </span>
                                                </h4>
                                            </div>
                                            <div class="widget-body">
                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <div  class="dd" id="sub-department">
                                                            <ol class="dd-list">
                                                                <!--<li class="dd-item" data-id="1">
                                                                    <div class="dd-handle">
                                                                        <i></i>
                                                                        飞创科技技术调研组（3人）
                                                                    </div>
                                                                </li>
                                                                <li class="dd-item" data-id="2">
                                                                    <div class="dd-handle">
                                                                        <i></i>
                                                                        飞创科技技术研发组（13人）
                                                                    </div>
                                                                </li>-->
                                                            </ol>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 部门人员 -->
                                        <div class="department-staff">
                                            <h4 class="pink">
                                                <i class="ace-icon fa fa-users icon-animated-hand-pointer blue"></i>
                                                <a href="#modal-table" role="button" class="green" data-toggle="modal"> 部门成员</a>
                                            </h4>
                                            <div class="hr hr-18 dotted hr-double"></div>


                                            <div class="widget-header widget-header-flat">
                                                <h4 class="smaller">
                                                    <button id="add-department-staff-btn" class="btn btn-white btn-info btn-bold">
                                                        <i class="ace-icon glyphicon glyphicon-plus small bigger-120 blue"></i>
                                                        添加成员
                                                    </button>
                                                    <button class="btn btn-white btn-warning btn-bold">
                                                        <i class="ace-icon fa fa-trash-o bigger-120 orange"></i>
                                                        批量删除
                                                    </button>
                                                </h4>
                                            </div>
                                            <div class="widget-body">
                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <table id="department-staff" class="table  table-bordered table-hover">
                                                            <thead class="department-staff-head">
                                                                <tr>
                                                                    <th class="center">
                                                                        <label class="pos-rel">
                                                                            <input type="checkbox" class="ace">
                                                                            <span class="lbl checkbox-all"></span>
                                                                        </label>
                                                                    </th>
                                                                    <th class="center">姓名</th>
                                                                    <th class="center">职位</th>
                                                                    <th class="center">工号</th>
                                                                    <th class="center">手机号</th>
                                                                    <th class="center">邮箱</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="department-staff-body center">
                                                                <!--<tr>
                                                                    <td>
                                                                        <label class="pos-rel">
                                                                            <input type="checkbox" class="ace">
                                                                            <span class="lbl"></span>
                                                                        </label>
                                                                    </td>
                                                                    <td>彭松涛</td>
                                                                    <td>保洁大叔</td>
                                                                    <td>9527</td>
                                                                    <td>1878192830</td>
                                                                    <td>santoetch@qq.com</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>
                                                                        <label class="pos-rel">
                                                                            <input type="checkbox" class="ace">
                                                                            <span class="lbl"></span>
                                                                        </label>
                                                                    </td>
                                                                    <td>彭松涛</td>
                                                                    <td>保洁大叔</td>
                                                                    <td>9527</td>
                                                                    <td>1878192830</td>
                                                                    <td>santoetch@qq.com</td>
                                                                </tr>-->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 角色管理 -->
                                    <div class="widget-box widget-main role-container display-none">
                                        <h3 class="header smaller lighter blue margin-top-0">
                                            主管理员
                                            <button type="button" class="btn btn-white btn-sm btn-primary">编辑</button>
                                        </h3>
                                        <div class="role-group-person-list">
                                            <div class="widget-header widget-header-flat">
                                                <h4 class="smaller">
                                                    <button class="btn btn-white btn-info btn-bold">
                                                        <i class="ace-icon glyphicon glyphicon-plus small bigger-120 blue"></i>
                                                        添加成员
                                                    </button>
                                                    <button class="btn btn-white btn-warning btn-bold">
                                                        <i class="ace-icon fa fa-trash-o bigger-120 orange"></i>
                                                        批量删除
                                                    </button>
                                                </h4>
                                            </div>
                                            <div class="widget-body">
                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <table id="role-group-person-list" class="table  table-bordered table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th class="center">
                                                                        <label class="pos-rel">
                                                                            <input type="checkbox" class="ace">
                                                                            <span class="lbl checkbox-all"></span>
                                                                        </label>
                                                                    </th>
                                                                    <th class="center">姓名</th>
                                                                    <th class="center">部门</th>
                                                                    <th class="center">工号</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr class="center">
                                                                    <td>
                                                                        <label class="pos-rel">
                                                                            <input type="checkbox" class="ace">
                                                                            <span class="lbl"></span>
                                                                        </label>
                                                                    </td>
                                                                    <td>彭松涛</td>
                                                                    <td>技术部</td>
                                                                    <td>9527</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 外部联系人 -->
                <div id="outcontacts" class="tab-pane fade background-white">
                    <div class="page-header">
                        <h1>通讯录管理</h1>
                    </div>
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="input-group">
                                <input type="text" class="form-control search-query" placeholder="输入关键字搜索">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-purple btn-sm">
                                        <span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
                                        搜索
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <div class="row">
                                <div class="col-xs-12">
                                    <div class="widget-box widget-main">
                                        <div class="outcontacts-container">
                                            <h4 class="pink">
                                                <i class="ace-icon fa fa-users icon-animated-hand-pointer blue"></i>
                                                <a href="#modal-table" role="button" class="green" data-toggle="modal">外部联系人</a>
                                            </h4>
                                            <div class="hr hr-18 dotted hr-double"></div>
                                            <div class="widget-header widget-header-flat">
                                                <h4 class="smaller">
                                                    <button class="btn btn-white btn-info btn-bold">
                                                        <i class="ace-icon glyphicon glyphicon-plus small bigger-120 blue"></i>
                                                        添加成员
                                                    </button>
                                                    <button class="btn btn-white btn-warning btn-bold">
                                                        <i class="ace-icon fa fa-trash-o bigger-120 orange"></i>
                                                        批量删除
                                                    </button>
                                                </h4>
                                            </div>
                                            <div class="widget-body">
                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <table id="outcontacts-list" class="table  table-bordered table-hover">
                                                            <thead class="department-staff-head">
                                                            <tr>
                                                                <th class="center">
                                                                    <label class="pos-rel">
                                                                        <input type="checkbox" class="ace">
                                                                        <span class="lbl checkbox-all"></span>
                                                                    </label>
                                                                </th>
                                                                <th class="center">姓名</th>
                                                                <th class="center">电话</th>
                                                                <th class="center">公司</th>
                                                                <th class="center">负责人</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody class="department-staff-body center">
                                                            <tr>
                                                                <td>
                                                                    <label class="pos-rel">
                                                                        <input type="checkbox" class="ace">
                                                                        <span class="lbl"></span>
                                                                    </label>
                                                                </td>
                                                                <td>彭松涛</td>
                                                                <td>1782232131</td>
                                                                <td>天马公司</td>
                                                                <td>天马</td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    <label class="pos-rel">
                                                                        <input type="checkbox" class="ace">
                                                                        <span class="lbl"></span>
                                                                    </label>
                                                                </td>
                                                                <td>彭松涛</td>
                                                                <td>1782232131</td>
                                                                <td>天马公司</td>
                                                                <td>天马</td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- dialog 编辑部门信息 -->
<div id="edit-department-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal"  role="form">
        <h4>部门信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="edit-department-name">部门名称:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-name" name="name" placeholder="请填写部门名称" class="form-control">
            </div>
        </div>
        <div class="form-group edit-organization-list-select display-none">
            <label class="col-sm-3 control-label no-padding-right" for="edit-upper-department-name-select">上级部门:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-upper-department-name-select" class="form-control" readonly>
                <ul id="edit-organization-list-select"  class="ztree display-none"></ul>
            </div>
        </div>
    </form>
</div>

<!-- 添加子部门 -->
<div id="add-sub-department-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>部门信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="add-sub-department-name">部门名称:</label>
            <div class="col-sm-9">
                <input type="text" id="add-sub-department-name" name="name" placeholder="请填写部门名称" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="add-upper-department-name">上级部门:</label>
            <div class="col-sm-9">
                <input type="hidden" name="parentid" id="add-upper-department-id">
                <input type="text" id="add-upper-department-name" class="form-control" readonly>
            </div>
        </div>
    </form>
</div>

<!-- 添加部门成员 -->
<!--<div id="add-department-staff-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>部门信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="add-sub-department-name">姓名:</label>
            <div class="col-sm-9">
                <input type="text" id="add-sub-department-name" placeholder="请填姓名" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="add-upper-department-name">部门:</label>
            <div class="col-sm-9">
                <input type="text" id="add-upper-department-name" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="add-upper-department-name">职位:</label>
            <div class="col-sm-9">
                <input type="text" id="add-upper-department-name" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="add-upper-department-name">邮箱:</label>
            <div class="col-sm-9">
                <input type="text" id="add-upper-department-name" class="form-control">
            </div>
        </div>
    </form>
</div>-->

<script type="text/javascript" th:inline="javascript">
    $(function () {
        //控制组织架构和角色内容展示
        var organizationContainer = $(".organization-container"), roleContainer = $(".role-container");
        $(".organization-menu").on("click", function () {
            organizationContainer.removeClass("display-none").siblings().removeClass("display-block").addClass("display-none");
        });
        $(".role-menu").on("click", function () {
            roleContainer.removeClass("display-none").siblings().removeClass("display-block").addClass("display-none");
        });

        //下级部门调整顺序
        $(".sub-department-queue").on("click", function () {
            $('.dd').nestable();
            $('.dd-handle a').on('mousedown', function(e){
                e.stopPropagation();
            });

            $(".sub-department-queue-save-cancel").removeClass("display-none");
            $("#sub-department li i").addClass("ace-icon fa fa-bars blue small smaller-90")
        });
        $(".sub-department-queue-save-cancel .cancel").on("click", function () {
            $(".sub-department-queue-save-cancel").addClass("display-none");
            window.location.reload();
        });
        $(".sub-department-queue-save-cancel .save").on("click", function () {
            $(".sub-department-queue-save-cancel").addClass("display-none");
        });

        //选所有checkbox
        $('th input[type=checkbox], td input[type=checkbox]').prop('checked', false);
        $(".department-staff-head .checkbox-all").on("click", function () {
            var departmentStaffBodyTr = $(".department-staff-body tr");
            if (departmentStaffBodyTr.hasClass("active")) {
                departmentStaffBodyTr.removeClass("active");
                departmentStaffBodyTr.find("td input[type=checkbox]").prop('checked', false)
            } else {
                departmentStaffBodyTr.addClass("active");
                departmentStaffBodyTr.find("td input[type=checkbox]").prop('checked', true)
            }
        });


        //获取组织架构列表 ztree
        var organizationSettings = {
            async: {
                enable: true,
                dataType: "json",
                type: "get",
                url: contextPath+"api/dingtalkdept/list",
                dataFilter: ajaxDataFilterFn
            },
            data:{
                key: {
                    name: "name"
                },
                simpleData : {
                    enable : true,
                    idKey: "id",
                    pIdKey: "parentid",
                    rootPId: 0
                }
            },
            callback: {
                onAsyncSuccess: organizationOnAsyncSuccessFn,
                onClick: organizationOnClick
            },
            view: {
                showLine: false
            }
        };

        function ajaxDataFilterFn(treeId, parentNode, responseData) {
            return responseData.content;

        }
        function organizationOnAsyncSuccessFn(event, treeId, treeNode, msg) {
            // 默认展示第一条数据
            if (msg.content.length) {
                $.each(msg.content, function (i, item) {
                    if (item.parentid == "0") {
                        var id = item.id;
                        $(".department-name").text(item.name).attr("data-id", id).attr("data-parentid", item.parentid);
                        $("#edit-department-name").attr("data-parentid", item.parentid);
                        $.ajax({
                            async : false,
                            cache:false,
                            type: 'get',
                            dataType : "json",
                            contentType: "application/json",
                            url: contextPath + "api/dingtalkdept/pid?pid="+id,
                            success:function(data){
                                if (data.status == "200") {
                                    //默认子级部门列表
                                    var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                                    subDepartmentOlBox.html('');
                                    if (data.content.depts.length) {
                                        var subDepartmentHtml = '';
                                        $(".sub-department-queue").removeClass("display-none");
                                        $.each(data.content.depts, function (i, item) {
                                            subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                                    '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                                    '</li>';
                                        });
                                    } else {
                                        $(".sub-department-queue").addClass("display-none");
                                        subDepartmentHtml = '<div class="alert alert-info center">'+
                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                '<i class="ace-icon fa fa-times"></i>'+
                                                '</button>'+
                                                '当前部门不包含下级部门请添加子部门'+
                                                '</div>';
                                    }
                                    subDepartmentOlBox.append(subDepartmentHtml);
                                    //默认部门人员列表
                                    departmentStaffBodyBox.html('');
                                    if (data.content.users.length) {
                                        var departmentStaffUserListHtml = '';
                                        $.each(data.content.users, function (i, item) {
                                            departmentStaffUserListHtml += '<tr>'+
                                                    '<td>'+
                                                    '<label class="pos-rel">'+
                                                    '<input type="checkbox" class="ace">'+
                                                    '<span class="lbl"></span>'+
                                                    '</label>'+
                                                    '</td>'+
                                                    '<td>'+ item.name +'</td>'+
                                                    '<td>'+ item.position +'</td>'+
                                                    '<td>'+ item.jobnumber +'</td>'+
                                                    '<td>'+ item.mobile +'</td>'+
                                                    '<td>'+ item.email +'</td>'+
                                                    '</tr>';
                                        });
                                    } else {
                                        departmentStaffUserListHtml = '<tr><td colspan="6">'+
                                                '<div class="alert alert-info">'+
                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                '<i class="ace-icon fa fa-times"></i>'+
                                                '</button>'+
                                                '当前部门暂无人员请添加成员'+
                                                '</div>'+
                                                '</td></tr>';
                                    }
                                    departmentStaffBodyBox.append(departmentStaffUserListHtml);
                                }
                            },
                            error: function () {
                                alert('请求失败');
                            }
                        });
                    }
                })
            }
        }
        function organizationOnClick(event, treeId, treeNode) {
//            console.log(treeNode.getParentNode());
            var id = treeNode.id;
            $(".department-name").text(treeNode.name).attr("data-id", id).attr("data-parentid", treeNode.parentid).attr("data-parentname", treeNode.getParentNode()?treeNode.getParentNode().name:"");
            $("#edit-department-name").attr("data-parentid", treeNode.parentid);
            $.ajax({
                async : false,
                cache:false,
                type: 'get',
                dataType : "json",
                contentType: "application/json",
                url: contextPath + "api/dingtalkdept/pid?pid="+id,
                success:function(data){
                    if (data.status == "200") {
                        //默认子级部门列表
                        var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                        subDepartmentOlBox.html('');
                        if (data.content.depts.length) {
                            var subDepartmentHtml = '';
                            $(".sub-department-queue").removeClass("display-none");
                            $.each(data.content.depts, function (i, item) {
                                subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                        '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                        '</li>';
                            });
                        } else {
                            $(".sub-department-queue").addClass("display-none");
                            subDepartmentHtml = '<div class="alert alert-info center">'+
                                    '<button type="button" class="close" data-dismiss="alert">'+
                                    '<i class="ace-icon fa fa-times"></i>'+
                                    '</button>'+
                                    '当前部门不包含下级部门请添加子部门'+
                                    '</div>';
                        }
                        subDepartmentOlBox.append(subDepartmentHtml);
                        //默认部门人员列表
                        departmentStaffBodyBox.html('');
                        if (data.content.users.length) {
                            var departmentStaffUserListHtml = '';
                            $.each(data.content.users, function (i, item) {
                                departmentStaffUserListHtml += '<tr>'+
                                        '<td>'+
                                        '<label class="pos-rel">'+
                                        '<input type="checkbox" class="ace">'+
                                        '<span class="lbl"></span>'+
                                        '</label>'+
                                        '</td>'+
                                        '<td>'+ item.name +'</td>'+
                                        '<td>'+ item.position +'</td>'+
                                        '<td>'+ item.jobnumber +'</td>'+
                                        '<td>'+ item.mobile +'</td>'+
                                        '<td>'+ item.email +'</td>'+
                                        '</tr>';
                            });
                        } else {
                            departmentStaffUserListHtml = '<tr><td colspan="6">'+
                                        '<div class="alert alert-info">'+
                                            '<button type="button" class="close" data-dismiss="alert">'+
                                            '<i class="ace-icon fa fa-times"></i>'+
                                            '</button>'+
                                            '当前部门暂无人员请添加成员'+
                                        '</div>'+
                                    '</td></tr>';
                        }
                        departmentStaffBodyBox.append(departmentStaffUserListHtml);
                    }
                },
                error: function () {
                    alert('请求失败');
                }
            });
        }
        function organizationRefreshNode() {
            /*根据 treeId 获取 zTree 对象*/
            var zTree = $.fn.zTree.getZTreeObj("organization-list");
            zTree.reAsyncChildNodes(null, "refresh");
        }
        $.fn.zTree.init($("#organization-list"), organizationSettings);


        // dialog 设置title
        $.widget("ui.dialog", $.extend({}, $.ui.dialog.prototype, {
            _title: function(title) {
                var $title = this.options.title || '&nbsp;';
                if( ("title_html" in this.options) && this.options.title_html == true )
                    title.html($title);
                else title.text($title);
            }
        }));



        //编辑部门信息
        $( "#edit-department-btn" ).on('click', function(e) {
            $("#edit-department-name").val($(".department-name").text()).attr("data-id", $(".department-name").attr("data-id"));
            $("#edit-upper-department-name-select").val($(".department-name").attr("data-parentname"));
            var id = $(".department-name").attr("data-id"), parentid = $(".department-name").attr("data-parentid"),
                displayStyle = "display-none";
            if (parentid != "0") {
                $(".edit-organization-list-select").removeClass("display-none");
                $("#edit-upper-department-name-select").on("click", function () {
                    $("#edit-organization-list-select").removeClass("display-none")
                });
                displayStyle = "display-inlin-block";
            } else {
                $("#edit-organization-list-select, .edit-organization-list-select").addClass("display-none")
            }
            //初始化edit-organization-list-select ztree
            var organizationSettings = {
                check: {
                    enable: true,
                    chkStyle: "radio",
                    radioType: "all"
                },
                async: {
                    enable: true,
                    dataType: "json",
                    type: "get",
                    url: contextPath+"api/dingtalkdept/list",
                    dataFilter: ajaxDataFilterFns
                },
                data:{
                    key: {
                        name: "name"
                    },
                    simpleData : {
                        enable : true,
                        idKey: "id",
                        pIdKey: "parentid",
                        rootPId: 0
                    }
                },
                callback: {
//                    onAsyncSuccess: organizationOnAsyncSuccessFn,
//                    onClick: organizationOnClick,
                    onCheck: organizationOnCheck
                },
                view: {
                    showLine: false
                }
            };
            function ajaxDataFilterFns(treeId, parentNode, responseData) {
                if (responseData.content) {
                    $.each(responseData.content, function (i, item) {
                        if (item.id == id) {
                            item["chkDisabled"] = true;
                        }
                    })
                }
                return responseData.content;
            }
            function organizationOnCheck(event, treeId, treeNode) {
                $("#edit-department-name").attr("data-parentid", treeNode.id);
                $("#edit-upper-department-name-select").val(treeNode.name);
            }
            $.fn.zTree.init($("#edit-organization-list-select"), organizationSettings);

            var validateForm = $('#edit-department-container>form').validate({
                errorElement: 'span',
                errorClass: 'help-block col-sm-3 control-label no-padding-right',
                focusInvalid: false,
                ignore: "",
                rules: {
                    name: {
                        required: true
                    }
                },
                highlight: function (e) {
                    $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
                },
                success: function (e) {
                    $(e).closest('.form-group').removeClass('has-error');
                    $(e).remove();
                },
                errorPlacement: function (error, element) {
                    error.insertAfter(element.parent());
                },
                invalidHandler: function (form) {
                }
            });
            e.preventDefault();
            var dialog = $( "#edit-department-container" ).removeClass('hide').dialog({
                resizable: false,
                width: '600',
                modal: true,
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑部门</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-primary btn-minier",
                        click: function() {
                            var _this = $(this), flag = validateForm.form(), editDepartmentName = $("#edit-department-name");
                            if(flag){
                                var data = {
                                    "name": editDepartmentName.val(),
                                    "id": editDepartmentName.attr("data-id"),
                                    "parentid": editDepartmentName.attr("data-parentid")
                                };
                                $.ajax({
                                    url: contextPath+"api/dingtalkdept/",
                                    type: "put",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        organizationRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
                                        console.log(data);
                                    }
                                })

                            }
                        }
                    },
                    {
                        text: "删除",
                        "class" : "btn btn-danger btn-minier "+displayStyle,
                        click: function() {
                            var _this = $(this),
                                data = {
                                "id": $("#edit-department-name").attr("data-id")
                            };
                            $.ajax({
                                url: contextPath+"api/dingtalkdept/?id="+id,
                                type: "delete",
                                contentType: "application/json",
                                dataType : "json",
                                success: function (data) {
                                    organizationRefreshNode();
                                    _this.dialog( "close" );
                                },
                                error: function (data) {
                                    console.log(data);
                                }
                            });
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });

        });


        var $form = $('#add-sub-department-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-3 control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                name: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });

        //添加子部门
        $( "#add-sub-department-btn" ).on('click', function(e) {
            $("#add-upper-department-name").val($(".department-name").text());
            $("#add-upper-department-id").val($(".department-name").attr("data-id"));
            e.preventDefault();
            var dialog = $( "#add-sub-department-container" ).removeClass('hide').dialog({
                resizable: false,
                width: '600',
                modal: true,
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;添加部门</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-primary btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $form.form();
                            if(flag){
                                var data = $('#add-sub-department-container>form').serializeObject();
                                $.ajax({
                                    url: contextPath+"api/dingtalkdept/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        organizationRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //添加部门成员
        $( "#add-department-staff-btn" ).on('click', function(e) {
            e.preventDefault();
            var dialog = $( "#add-department-staff-container" ).removeClass('hide').dialog({
                resizable: false,
                width: '600',
                modal: true,
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;添加成员</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-primary btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });
    });
</script>
</body>
</html>
