<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
    <head>
        <link rel="stylesheet" th:href="@{/dist/css/dingtalkuser.css}" />
        <style>
            .nav-tabs.tab-color-blue>li.active>a, .nav-tabs.tab-color-blue>li.active>a:focus, .nav-tabs.tab-color-blue>li.active>a:hover {
                color: #1794e4;
                border-color: #1794e4 #1794e4 transparent;

            }
            .nav-tabs.tab-color-blue>li>a, .nav-tabs.tab-color-blue>li>a:focus {
                background-color: #1794e4;
            }
            h4.smaller {
                font-size: 17px;
                color: #1794e4 !important;
            }
        </style>
    </head>
<body layout:fragment="content">
<div class="row">

    <div class="page-header">
        <h1>通讯录管理</h1>
    </div>
    <div class="tabbable">
        <ul class="nav nav-tabs" id="myTab">
            <li class="col-sm-6 active no-padding">
                <a data-toggle="tab" href="#insidecontacts" aria-expanded="true">
                    <!--<i class="green ace-icon fa fa-book bigger-120"></i>-->
                    内部通讯录管理
                </a>
            </li>
            <li class="col-sm-6 no-padding">
                <a data-toggle="tab" href="#outcontacts" aria-expanded="false">
                    <!--<i class="green ace-icon glyphicon glyphicon-list-alt bigger-120"></i>-->
                    外部联系人
                </a>
            </li>
        </ul>

        <div class="tab-content border-none">
            <!-- 内部通讯录管理 -->
            <div id="insidecontacts" class="tab-pane fade active in background-white">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="input-group display-none">
                            <input type="text" class="form-control search-query" placeholder="输入关键字搜索">
                            <span class="input-group-btn">
                                    <button type="button" class="btn btn-purple btn-sm">
                                        <span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
                                        搜索
                                    </button>
                                </span>
                        </div>
                        <div class="tabbable">
                            <ul class="nav nav-tabs padding-12 tab-color-blue background-blue" id="myTab4">
                                <li class="active organization-menu">
                                    <a data-toggle="tab" href="#organization-menu" aria-expanded="true">组织架构</a>
                                </li>
                                <li class="role-menu">
                                    <a data-toggle="tab" href="#role-menu" aria-expanded="false">角色</a>
                                </li>
                            </ul>

                            <div class="tab-content">
                                <div id="organization-menu" class="tab-pane active">
                                    <ul id="organization-list"  class="ztree"></ul>
                                </div>

                                <div id="role-menu" class="tab-pane align-center">
                                    <p><button type="button" class="btn btn-white btn-default add-role-group-btn">新增角色组</button><button type="button" class="btn btn-white btn-default add-role-person-btn">新增角色</button></p>
                                    <ul id="role-list"  class="ztree"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-8">
                        <div class="row">
                            <div class="col-xs-12">
                                <!-- 组织架构 -->
                                <div class="widget-box widget-main organization-container">
                                    <h3 class="header smaller lighter blue margin-top-0">
                                        <span class="department-name"></span>
                                        <!--<small class="btn-warning padding-3">全员群</small>-->
                                        <button id="edit-department-btn" type="button" class="btn btn-white btn-sm btn-primary" style="border-color: #1794e4; color: #1794e4 !important;">
                                            <i class="ace-icon fa  fa-cog small bigger-120 blue"></i>
                                            设置
                                        </button>
                                    </h3>
                                    <!-- 下级部门 -->
                                    <div class="sub-department">
                                        <h4 class="pink">
                                            <i class="ace-icon fa fa-sitemap icon-animated-hand-pointer blue"></i>
                                            <a href="#modal-table" role="button" class="blue" data-toggle="modal"> 下级部门</a>
                                        </h4>
                                        <div class="hr hr-18 dotted hr-double"></div>
                                        <div class="widget-header widget-header-flat">
                                            <h4 class="smaller btn-group">
                                                <button id="add-sub-department-btn" class="btn btn-info">
                                                    <i class="ace-icon glyphicon glyphicon-plus small bigger-120 white"></i>
                                                    添加子部门
                                                </button>
                                                <!--<button class="btn btn-info sub-department-queue display-none">
                                                    <i class="ace-icon fa fa-bars small bigger-120 blue"></i>
                                                    调整顺序
                                                </button>-->
                                                <span class="sub-department-queue-save-cancel display-none">
                                                        <button type="button" class="btn btn-white btn-default save">
                                                            <i class="ace-icon fa fa-floppy-o bigger-120 blue"></i>保存
                                                        </button>
                                                        <button type="button" class="btn btn-white btn-default cancel">
                                                            <i class="ace-icon fa fa-times red2"></i>取消
                                                        </button>
                                                    </span>
                                            </h4>
                                        </div>
                                        <div class="widget-body">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <div  class="dd" id="sub-department">
                                                        <ol class="dd-list">
                                                            <!--<li class="dd-item" data-id="1">
                                                                <div class="dd-handle">
                                                                    <i></i>
                                                                    飞创科技技术调研组（3人）
                                                                </div>
                                                            </li>
                                                            <li class="dd-item" data-id="2">
                                                                <div class="dd-handle">
                                                                    <i></i>
                                                                    飞创科技技术研发组（13人）
                                                                </div>
                                                            </li>-->
                                                        </ol>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 部门人员 -->
                                    <div class="department-staff">
                                        <h4 class="pink">
                                            <i class="ace-icon fa fa-users icon-animated-hand-pointer blue"></i>
                                            <a href="#modal-table" role="button" class="blue" data-toggle="modal"> 部门成员</a>
                                        </h4>
                                        <div class="hr hr-18 dotted hr-double"></div>


                                        <div class="widget-header widget-header-flat">
                                            <h4 class="smaller btn-group">
                                                <button id="add-department-staff-btn" class="btn btn-info">
                                                    <!--<i class="ace-icon glyphicon glyphicon-plus small bigger-120 white"></i>-->
                                                    添加成员
                                                </button>
                                                <button id="add-department-staff-del-btn" class="btn btn-danger">
                                                    <!--<i class="ace-icon fa fa-trash-o bigger-120 orange"></i>-->
                                                    批量删除
                                                </button>
                                            </h4>
                                        </div>
                                        <div class="widget-body">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <table id="department-staff" class="table  table-bordered table-hover">
                                                        <thead class="department-staff-head">
                                                        <tr>
                                                            <th class="center">
                                                                <label class="pos-rel">
                                                                    <input type="checkbox" class="ace">
                                                                    <span class="lbl checkbox-all"></span>
                                                                </label>
                                                            </th>
                                                            <th class="center">姓名</th>
                                                            <th class="center">职位</th>
                                                            <th class="center">工号</th>
                                                            <th class="center">手机号</th>
                                                            <th class="center">邮箱</th>
                                                            <th class="center">操作</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody class="department-staff-body center">
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 角色管理 -->
                                <div class="widget-box widget-main role-container display-none">
                                    <h3 class="header smaller lighter blue margin-top-0">
                                        <span id="role-person-name">主管理员</span>
                                        <button type="button" class="btn btn-white btn-sm btn-primary" id="edit-role-person-btn">编辑</button>
                                    </h3>
                                    <div class="role-group-person-list">
                                        <div class="widget-header widget-header-flat">
                                            <h4 class="smaller btn-group">
                                                <!--<button class="btn btn-info">
                                                    <i class="ace-icon glyphicon glyphicon-plus small bigger-120 white"></i>
                                                    添加成员
                                                </button>-->
                                                <button id="role-group-person-list-del" class="btn btn-danger">
                                                    <!--<i class="ace-icon fa fa-trash-o bigger-120 orange"></i>-->
                                                    批量删除
                                                </button>
                                            </h4>
                                        </div>
                                        <div class="widget-body">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <table id="role-group-person-list" class="table  table-bordered table-hover">
                                                        <thead class="role-group-person-list-head">
                                                            <tr>
                                                                <th class="center">
                                                                    <label class="pos-rel">
                                                                        <input type="checkbox" class="ace">
                                                                        <span class="lbl checkbox-all"></span>
                                                                    </label>
                                                                </th>
                                                                <th class="center">姓名</th>
                                                                <th class="center">部门</th>
                                                                <th class="center">工号</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="role-group-person-list-body">
                                                           <!-- <tr class="center">
                                                                <td>
                                                                    <label class="pos-rel">
                                                                        <input type="checkbox" class="ace">
                                                                        <span class="lbl"></span>
                                                                    </label>
                                                                </td>
                                                                <td>彭松涛</td>
                                                                <td>技术部</td>
                                                                <td>9527</td>
                                                            </tr>-->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 外部联系人 -->
            <div id="outcontacts" class="tab-pane fade background-white">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="input-group display-none">
                            <input type="text" class="form-control search-query" placeholder="输入关键字搜索">
                            <span class="input-group-btn">
                                    <button type="button" class="btn btn-purple btn-sm">
                                        <span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
                                        搜索
                                    </button>
                            </span>
                        </div>
                        <div class="tabbable">
                            <ul class="nav nav-tabs padding-12 tab-color-blue background-blue"  id="myTab5">
                                <li class="active tag-menu">
                                    <a data-toggle="tab" href="#tag-menu" aria-expanded="true">标签</a>
                                </li>
                            </ul>

                            <div class="tab-content">
                                <div id="tag-menu" class="align-center">
                                    <p><button type="button" class="btn btn-white btn-default add-tag-group-btn">新增标签组</button><button type="button" class="btn btn-white btn-default add-tag-btn">新增标签</button></p>
                                    <ul id="tag-list"  class="ztree"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-8">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="widget-box widget-main">
                                    <div class="outcontacts-container">
                                        <h4 class="pink">
                                            <i class="ace-icon fa fa-users icon-animated-hand-pointer blue"></i>
                                            <a href="#modal-table" role="button" class="blue" data-toggle="modal">外部联系人</a>
                                        </h4>
                                        <div class="hr hr-18 dotted hr-double"></div>
                                        <div class="widget-header widget-header-flat">
                                            <h4 class="smaller btn-group">
                                                <button class="btn btn-info add-outcontacts-btn">
                                                    <!--<i class="ace-icon glyphicon glyphicon-plus small bigger-120 white"></i>-->
                                                    添加成员
                                                </button>
                                                <button class="btn btn-danger del-outcontacts-btn">
                                                    <!--<i class="ace-icon fa fa-trash-o bigger-120 orange"></i>-->
                                                    批量删除
                                                </button>
                                            </h4>
                                        </div>
                                        <div class="widget-body">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <table id="outcontacts-list" class="table  table-bordered table-hover">
                                                        <thead class="outcontacts-list-head">
                                                        <tr>
                                                            <th class="center">
                                                                <label class="pos-rel">
                                                                    <input type="checkbox" class="ace">
                                                                    <span class="lbl checkbox-all"></span>
                                                                </label>
                                                            </th>
                                                            <th class="center">姓名</th>
                                                            <th class="center">电话</th>
                                                            <th class="center">公司</th>
                                                            <th class="center">负责人</th>
                                                            <th class="center">操作</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody class="outcontacts-list-body center">
                                                        <!--<tr>
                                                            <td>
                                                                <label class="pos-rel">
                                                                    <input type="checkbox" class="ace">
                                                                    <span class="lbl"></span>
                                                                </label>
                                                            </td>
                                                            <td>彭松涛</td>
                                                            <td>1782232131</td>
                                                            <td>天马公司</td>
                                                            <td>天马</td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <label class="pos-rel">
                                                                    <input type="checkbox" class="ace">
                                                                    <span class="lbl"></span>
                                                                </label>
                                                            </td>
                                                            <td>彭松涛</td>
                                                            <td>1782232131</td>
                                                            <td>天马公司</td>
                                                            <td>天马</td>
                                                        </tr>-->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- dialog 编辑部门信息 -->
<div id="edit-department-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal"  role="form">
        <h4>部门信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-name">部门名称:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-name" name="name" placeholder="请填写部门名称" class="form-control">
            </div>
        </div>
        <div class="form-group edit-organization-list-select display-none">
            <label class="col-sm-2 control-label no-padding-right" for="edit-upper-department-name-select">上级部门:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-upper-department-name-select" class="form-control" readonly>
                <ul id="edit-organization-list-select"  class="ztree display-none"></ul>
            </div>
        </div>
    </form>
</div>

<!-- 添加子部门 -->
<div id="add-sub-department-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>部门信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-2 control-label no-padding-right" for="add-sub-department-name">部门名称:</label>
            <div class="col-sm-9">
                <input type="text" id="add-sub-department-name" name="name" placeholder="请填写部门名称" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label no-padding-right" for="add-upper-department-name">上级部门:</label>
            <div class="col-sm-9">
                <input type="hidden" name="parentid" id="add-upper-department-id">
                <input type="text" id="add-upper-department-name" class="form-control" readonly>
            </div>
        </div>
    </form>
</div>

<!-- 添加部门成员 -->
<div id="add-department-staff-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>用户信息</h4>
        <div class="hr hr-12 hr-double"></div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-username">姓名:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-username" name="username" placeholder="请输入姓名" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-departmentname-btn">部门:</label>
            <div class="col-sm-9">
                <input type="hidden" name="departmentname" class="form-control">
                <button type="button" id="add-department-staff-departmentname-btn" name="departmentname" class="form-control btn btn-white btn-default">请选择部门</button>
                <ul id="add-department-staff-departmentname-select"  class="ztree display-none"></ul>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-position">职位:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-position" placeholder="请输入职位" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-role-btn">角色:</label>
            <div class="col-sm-9">
                <input type="hidden" name="role" class="form-control">
                <button type="button" id="add-department-staff-role-btn" name="role" class="form-control btn btn-white btn-default">请选择角色</button>
                <ul id="add-department-staff-role-select"  class="ztree display-none"></ul>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-jobnumber">工号:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-jobnumber" placeholder="请输入工号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-phone">手机号:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-phone" name="phone" placeholder="请输入手机号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-tel">分机号:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-tel" placeholder="请输入分机号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-email">邮箱:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-email" placeholder="请输入邮箱" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-workplace">办公地点:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-workplace" placeholder="请输入办公地点" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-remark">备注:</label>
            <div class="col-sm-9">
                <input type="text" id="add-department-staff-remark" placeholder="请输入备注" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-password">密码:</label>
            <div class="col-sm-9">
                <input type="password" id="add-department-staff-password" name="password" placeholder="请输入密码" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-department-staff-repassword">确认密码:</label>
            <div class="col-sm-9">
                <input type="password" id="add-department-staff-repassword" name="confirm_password" placeholder="请输入备注" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 编辑部门成员 -->
<div id="edit-department-staff-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>用户信息</h4>
        <div class="hr hr-12 hr-double"></div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-username">姓名:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-username" name="username" placeholder="请输入姓名" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-departmentname-btn">部门:</label>
            <div class="col-sm-9">
                <input type="hidden" name="departmentname" class="form-control">
                <button type="button" id="edit-department-staff-departmentname-btn" name="role" class="form-control btn btn-white btn-default">请选择部门</button>
                <ul id="edit-department-staff-departmentname-select"  class="ztree display-none"></ul>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-position">职位:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-position" placeholder="请输入职位" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-role-btn">角色:</label>
            <div class="col-sm-9">
                <input type="hidden" name="role" class="form-control">
                <button type="button" id="edit-department-staff-role-btn" name="role" class="form-control btn btn-white btn-default">请选择角色</button>
                <ul id="edit-department-staff-role-select"  class="ztree display-none"></ul>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-jobnumber">工号:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-jobnumber" placeholder="请输入工号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-phone">手机号:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-phone" name="phone" placeholder="请输入手机号" class="form-control" readonly>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-tel">分机号:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-tel" placeholder="请输入分机号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-email">邮箱:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-email" placeholder="请输入邮箱" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-workplace">办公地点:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-workplace" placeholder="请输入办公地点" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-department-staff-remark">备注:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-department-staff-remark" placeholder="请输入备注" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 新增角色组 -->
<div id="add-role-group-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>角组信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-2 control-label no-padding-right" for="add-role-group-name">角色组名称:</label>
            <div class="col-sm-9">
                <input type="text" id="add-role-group-name" name="roleName" placeholder="请填写角色组名称" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 编辑角色组 -->
<div id="edit-role-group-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>角色组信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group">
            <label class="col-sm-2 control-label no-padding-right" for="edit-role-group-name">角色组名称:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-role-group-name" name="roleName" placeholder="请填写角色组名称" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 新增角色 -->
<div id="add-role-person-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>角色信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-role-person-name">角色名称:</label>
            <div class="col-sm-9">
                <input type="text" id="add-role-person-name" name="roleName" placeholder="请填写角色组名称" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-role-person-rcompetence">权限:</label>
            <div class="col-sm-9">
                <button type="button" id="add-role-person-rcompetence" name="role" class="form-control btn btn-white btn-default">请选择权限</button>
                <ul id="add-role-person-competence-select"  class="ztree display-none"></ul>
            </div>
        </div>
        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-role-group-name">分组到:</label>
            <div class="col-sm-9">
                <select class="form-control" id="add-role-person-group" name="groupId">
                    <option value="" disabled selected class="first-option">请选择角色组</option>
                </select>
            </div>
        </div>
    </form>
</div>

<!-- 编辑角色 -->
<div id="edit-role-person-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>角色信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-role-person-name">角色名称:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-role-person-name" name="roleName" placeholder="请填写角色组名称" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-role-person-rcompetence">权限:</label>
            <div class="col-sm-9">
                <button type="button" id="edit-role-person-rcompetence" name="role" class="form-control btn btn-white btn-default">更改权限</button>
                <ul id="edit-role-person-competence-select"  class="ztree display-none"></ul>
            </div>
        </div>
        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-role-group-name">分组到:</label>
            <div class="col-sm-9">
                <select class="form-control" id="edit-role-person-group" name="groupId">
                </select>
            </div>
        </div>
    </form>
</div>

<!-- 改变密码 -->
<div id="change-password-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>用户密码</h4>
        <div class="hr hr-12 hr-double"></div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="change-password-password">密码:</label>
            <div class="col-sm-9">
                <input type="password" id="change-password-password" name="password" placeholder="请输入密码" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="change-password-repassword">确认密码:</label>
            <div class="col-sm-9">
                <input type="password" id="change-password-repassword" name="confirm_password" placeholder="请输入备注" class="form-control">
            </div>
        </div>
    </form>
</div>

<!--  外部联系人 -->
<!-- 新增标签组 -->
<div id="add-tag-group-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>标签组信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-tag-group-name">标签组名称:</label>
            <div class="col-sm-9">
                <input type="text" id="add-tag-group-name" name="roleName" placeholder="请填写标签组名称" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 编辑标签组 -->
<div id="edit-tag-group-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>标签组信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-tag-group-name">标签组名称:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-tag-group-name" name="tagName" placeholder="请填写标签组名称" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 新增标签 -->
<div id="add-tag-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>标签信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-role-group-name">标签组:</label>
            <div class="col-sm-9">
                <select class="form-control" id="add-tag-group" name="groupId">
                </select>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-tag-name">标签名称:</label>
            <div class="col-sm-9">
                <input type="text" id="add-tag-name" name="roleName" placeholder="请填写标签名称" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 编辑标签 -->
<div id="edit-tag-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>标签信息</h4>
        <div class="hr hr-12 hr-double"></div>

        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-tag-group">标签组:</label>
            <div class="col-sm-9">
                <select class="form-control" id="edit-tag-group" name="groupId">
                </select>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-tag-name">标签名称:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-tag-name" name="tagName" placeholder="请填写标签名称" class="form-control">
            </div>
        </div>
    </form>
</div>

<!-- 添加外部成员 -->
<div id="add-outcontacts-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>外部联系人详情</h4>
        <div class="hr hr-12 hr-double"></div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-username">姓名:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-username" name="username" placeholder="请输入姓名" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-phone">手机号:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-phone" name="phone" placeholder="请输入手机号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-company">公司:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-company" placeholder="请输入公司" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-position">职位:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-position" placeholder="请输入职位" class="form-control">
            </div>
        </div>

        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-email">邮箱:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-email" placeholder="请输入邮箱" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-address">地址:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-address" placeholder="请输入地址" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-remark">备注:</label>
            <div class="col-sm-9">
                <input type="text" id="add-outcontacts-remark" placeholder="请输入备注" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="outcontacts-principal">负责人:</label>
            <div class="col-sm-9">
                <select class="form-control" id="outcontacts-principal" name="groupId">
                </select>
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="add-outcontacts-tag-btn">标签:</label>
            <div class="col-sm-9">
                <input type="hidden" name="addOutcontactsTag" class="form-control">
                <button type="button" id="add-outcontacts-tag-btn" name="role" class="form-control btn btn-white btn-default">请选择标签</button>
                <ul id="add-outcontacts-tag-select" ></ul>
            </div>
        </div>
    </form>
</div>

<!--编辑外部成员 -->
<div id="edit-outcontacts-container" class="ui-dialog-content ui-widget-content display-none" style="width: auto; min-height: 30px; max-height: none; height: auto;">
    <form class="form-horizontal" role="form">
        <h4>外部联系人详情</h4>
        <div class="hr hr-12 hr-double"></div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-username">姓名:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-username" name="username" placeholder="请输入姓名" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-phone">手机号:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-phone" name="phone" placeholder="请输入手机号" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-company">公司:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-company" placeholder="请输入公司" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-position">职位:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-position" placeholder="请输入职位" class="form-control">
            </div>
        </div>

        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-email">邮箱:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-email" placeholder="请输入邮箱" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-address">地址:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-address" placeholder="请输入地址" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-remark">备注:</label>
            <div class="col-sm-9">
                <input type="text" id="edit-outcontacts-remark" placeholder="请输入备注" class="form-control">
            </div>
        </div>
        <div class="form-group col-sm-12 col-md-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-principal">负责人:</label>
            <div class="col-sm-9">
                <select class="form-control" id="edit-outcontacts-principal" name="groupId">
                </select>
            </div>
        </div>
        <div class="form-group col-sm-12">
            <label class="col-sm-2 control-label no-padding-right" for="edit-outcontacts-tag-btn">标签:</label>
            <div class="col-sm-9">
                <input type="hidden" name="editOutcontactsTag" class="form-control">
                <button type="button" id="edit-outcontacts-tag-btn" name="role" class="form-control btn btn-white btn-default">请选择标签</button>
                <ul id="edit-outcontacts-tag-select" ></ul>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript" th:inline="javascript">
    $(function () {
        //控制组织架构和角色内容展示
        var organizationContainer = $(".organization-container"), roleContainer = $(".role-container");
        $(".organization-menu").on("click", function () {
            organizationContainer.removeClass("display-none").siblings().removeClass("display-block").addClass("display-none");
        });
        $(".role-menu").on("click", function () {
            roleContainer.removeClass("display-none").siblings().removeClass("display-block").addClass("display-none");
            var defaultHtml = '<div class="alert alert-info defaultHtml" style="margin: 0;"><button type="button" class="close" data-dismiss="alert"><i class="ace-icon fa fa-times"></i></button>请选择角色</div>';
            roleContainer.find("h3, .role-group-person-list").addClass("display-none");
            if (!roleContainer.find(".alert").hasClass("defaultHtml")) {
                roleContainer.append(defaultHtml);
            }
        });

        //下级部门调整顺序
        $(".sub-department-queue").on("click", function () {
            $('.dd').nestable();
            $('.dd-handle a').on('mousedown', function(e){
                e.stopPropagation();
            });

            $(".sub-department-queue-save-cancel").removeClass("display-none");
            $("#sub-department li i").addClass("ace-icon fa fa-bars blue small smaller-90")
        });
        $(".sub-department-queue-save-cancel .cancel").on("click", function () {
            $(".sub-department-queue-save-cancel").addClass("display-none");
            window.location.reload();
        });
        $(".sub-department-queue-save-cancel .save").on("click", function () {
            $(".sub-department-queue-save-cancel").addClass("display-none");
        });

        //取消所有checkbox
        $('th input[type=checkbox], td input[type=checkbox]').prop('checked', false);
        //获取组织架构列表 ztree
        var organizationSettings = {
            async: {
                enable: true,
                dataType: "json",
                type: "get",
                url: contextPath+"api/dingtalkdept/list",
                dataFilter: ajaxDataFilterFn
            },
            data:{
                key: {
                    name: "name"
                },
                simpleData : {
                    enable : true,
                    idKey: "id",
                    pIdKey: "parentid",
                    rootPId: 0
                }
            },
            callback: {
                onAsyncSuccess: organizationOnAsyncSuccessFn,
                onClick: organizationOnClick
            },
            view: {
                showLine: false
            }
        };
        function ajaxDataFilterFn(treeId, parentNode, responseData) {
            return responseData.content;

        }
        function organizationOnAsyncSuccessFn(event, treeId, treeNode, msg) {
            // 默认展示第一条数据
            if (msg.content.length) {
                $.each(msg.content, function (i, item) {
                    if (item.parentid == "0") {
                        var id = item.id;
                        $(".department-name").text(item.name).attr("data-id", id).attr("data-parentid", item.parentid);
                        $("#edit-department-name").attr("data-parentid", item.parentid);
                        $.ajax({
                            async : false,
                            cache:false,
                            type: 'get',
                            dataType : "json",
                            contentType: "application/json",
                            url: contextPath + "api/dingtalkdept/pid?pid="+id,
                            success:function(data){
                                if (data.status == "200") {
                                    //默认子级部门列表
                                    var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                                    subDepartmentOlBox.html('');
                                    if (data.content.depts.length) {
                                        var subDepartmentHtml = '';
                                        $(".sub-department-queue").removeClass("display-none");
                                        $.each(data.content.depts, function (i, item) {
                                            subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                                    '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                                    '</li>';
                                        });
                                    } else {
                                        $(".sub-department-queue").addClass("display-none");
                                        subDepartmentHtml = '<div class="alert alert-info center">'+
                                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                                '<i class="ace-icon fa fa-times"></i>'+
                                                                '</button>'+
                                                                '当前部门不包含下级部门请添加子部门'+
                                                            '</div>';
                                    }
                                    subDepartmentOlBox.append(subDepartmentHtml);
                                    //默认部门人员列表
                                    departmentStaffBodyBox.html('');
                                    if (data.content.users.length) {
                                        var departmentStaffUserListHtml = '';
                                        $.each(data.content.users, function (i, item) {
                                            var checkedDisabled = "";
                                            if (item.isAdmin) {
                                                checkedDisabled = "disabled";
                                            }
                                            departmentStaffUserListHtml += '<tr>'+
                                                    '<td>'+
                                                    '<label class="pos-rel">'+
                                                    '<input type="checkbox" '+ checkedDisabled +' data-id="'+ item.userid +'" data-del="'+ item.isAdmin +'" class="ace">'+
                                                    '<span class="lbl"></span>'+
                                                    '</label>'+
                                                    '</td>'+
                                                    '<td>'+ item.name +'</td>'+
                                                    '<td>'+ item.position +'</td>'+
                                                    '<td>'+ item.jobnumber +'</td>'+
                                                    '<td>'+ item.mobile +'</td>'+
                                                    '<td>'+ item.email +'</td>'+
                                                    '<td data-id="'+ item.userid +'" data-isAdmin="'+ item.isAdmin +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-btn" title="编辑信息"></i>&nbsp;&nbsp;<i class="ace-icon fa fa-key bigger-110 icon-only change-password-btn" title="修改密码"></i></td>'+
                                                    '</tr>';
                                        });
                                    } else {
                                        departmentStaffUserListHtml = '<tr><td colspan="7">'+
                                                '<div class="alert alert-info">'+
                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                '<i class="ace-icon fa fa-times"></i>'+
                                                '</button>'+
                                                '当前部门暂无人员请添加成员'+
                                                '</div>'+
                                                '</td></tr>';
                                    }
                                    departmentStaffBodyBox.append(departmentStaffUserListHtml);
                                    $("#department-staff .edit-btn").on("click", function () {
                                        var _this = $(this);
                                        editDepartmentStaffInfo(_this.parents("td").attr("data-id"), _this.parents("td").attr("data-isAdmin"));
                                    });
                                    $(".change-password-btn").on("click", function () {
                                        var _this = $(this);
                                        changePassword(_this.parents("td").attr("data-id"))
                                    });
                                }
                            },
                            error: function () {
//                                alert('请求失败');
                            }
                        });
                    }
                })
            }
        }
        function organizationOnClick(event, treeId, treeNode) {
            var id = treeNode.id;
            $(".department-name").text(treeNode.name).attr("data-id", id).attr("data-parentid", treeNode.parentid).attr("data-parentname", treeNode.getParentNode()?treeNode.getParentNode().name:"");
            $("#edit-department-name").attr("data-parentid", treeNode.parentid);
            $.ajax({
                async : false,
                cache:false,
                type: 'get',
                dataType : "json",
                contentType: "application/json",
                url: contextPath + "api/dingtalkdept/pid?pid="+id,
                success:function(data){
                    if (data.status == "200") {
                        //默认子级部门列表
                        var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                        subDepartmentOlBox.html('');
                        if (data.content.depts.length) {
                            var subDepartmentHtml = '';
                            $(".sub-department-queue").removeClass("display-none");
                            $.each(data.content.depts, function (i, item) {
                                subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                        '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                        '</li>';
                            });
                        } else {
                            $(".sub-department-queue").addClass("display-none");
                            subDepartmentHtml = '<div class="alert alert-info center">'+
                                    '<button type="button" class="close" data-dismiss="alert">'+
                                    '<i class="ace-icon fa fa-times"></i>'+
                                    '</button>'+
                                    '当前部门不包含下级部门请添加子部门'+
                                    '</div>';
                        }
                        subDepartmentOlBox.append(subDepartmentHtml);
                        //默认部门人员列表
                        departmentStaffBodyBox.html('');
                        if (data.content.users.length) {
                            var departmentStaffUserListHtml = '';
                            $.each(data.content.users, function (i, item) {
                                var checkedDisabled = "";
                                if (item.isAdmin) {
                                    checkedDisabled = "disabled";
                                }
                                departmentStaffUserListHtml += '<tr>'+
                                        '<td>'+
                                        '<label class="pos-rel">'+
                                        '<input type="checkbox" '+ checkedDisabled +' data-id="'+ item.userid +'" data-del="'+ item.isAdmin +'" class="ace">'+
                                        '<span class="lbl"></span>'+
                                        '</label>'+
                                        '</td>'+
                                        '<td>'+ item.name +'</td>'+
                                        '<td>'+ item.position +'</td>'+
                                        '<td>'+ item.jobnumber +'</td>'+
                                        '<td>'+ item.mobile +'</td>'+
                                        '<td>'+ item.email +'</td>'+
                                        '<td data-id="'+ item.userid +'" data-isAdmin="'+ item.isAdmin +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-btn" title="编辑信息"></i>&nbsp;&nbsp;<i class="ace-icon fa fa-key bigger-110 icon-only change-password-btn" title="修改密码"></i></td>'+
                                        '</tr>';
                            });
                        } else {
                            departmentStaffUserListHtml = '<tr><td colspan="7">'+
                                        '<div class="alert alert-info">'+
                                            '<button type="button" class="close" data-dismiss="alert">'+
                                            '<i class="ace-icon fa fa-times"></i>'+
                                            '</button>'+
                                            '当前部门暂无人员请添加成员'+
                                        '</div>'+
                                    '</td></tr>';
                        }
                        departmentStaffBodyBox.append(departmentStaffUserListHtml);
                        $("#department-staff .edit-btn").on("click", function () {
                            var _this = $(this);
                            editDepartmentStaffInfo(_this.parents("td").attr("data-id"), _this.parents("td").attr("data-isAdmin"));
                        });
                        $(".change-password-btn").on("click", function () {
                            var _this = $(this);
                            changePassword(_this.parents("td").attr("data-id"))
                        });
                    }
                },
                error: function () {
//                    alert('请求失败');
                }
            });
        }
        function organizationRefreshNode() {
            /*根据 treeId 获取 zTree 对象*/
            var zTree = $.fn.zTree.getZTreeObj("organization-list");
            zTree.reAsyncChildNodes(null, "refresh");
        }
        $.fn.zTree.init($("#organization-list"), organizationSettings);


        // dialog 设置title
        $.widget("ui.dialog", $.extend({}, $.ui.dialog.prototype, {
            _title: function(title) {
                var $title = this.options.title || '&nbsp;';
                if( ("title_html" in this.options) && this.options.title_html == true )
                    title.html($title);
                else title.text($title);
            }
        }));

        var validateForm = $('#edit-department-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                name: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        //编辑部门信息
        $( "#edit-department-btn" ).on('click', function(e) {
            validateResetForm(validateForm, $('#edit-department-container>form'));
            $("#edit-department-name").val($(".department-name").text()).attr("data-id", $(".department-name").attr("data-id"));
            $("#edit-upper-department-name-select").val($(".department-name").attr("data-parentname"));
            var id = $(".department-name").attr("data-id"), parentid = $(".department-name").attr("data-parentid"),
                displayStyle = "display-none";
            if (parentid != "0") {
                $(".edit-organization-list-select").removeClass("display-none");
                $("#edit-upper-department-name-select").on("click", function () {
                    $("#edit-organization-list-select").removeClass("display-none")
                });
                displayStyle = "display-inlin-block";
            } else {
                $("#edit-organization-list-select, .edit-organization-list-select").addClass("display-none")
            }
            //初始化edit-organization-list-select ztree
            var organizationSettings = {
                check: {
                    enable: true,
                    chkStyle: "radio",
                    radioType: "all"
                },
                async: {
                    enable: true,
                    dataType: "json",
                    type: "get",
                    url: contextPath+"api/dingtalkdept/list",
                    dataFilter: ajaxDataFilterFns
                },
                data:{
                    key: {
                        name: "name"
                    },
                    simpleData : {
                        enable : true,
                        idKey: "id",
                        pIdKey: "parentid",
                        rootPId: 0
                    }
                },
                callback: {
//                    onAsyncSuccess: organizationOnAsyncSuccessFn,
//                    onClick: organizationOnClick,
                    onCheck: organizationOnCheck
                },
                view: {
                    showLine: false
                }
            };
            function ajaxDataFilterFns(treeId, parentNode, responseData) {
                if (responseData.content) {
                    $.each(responseData.content, function (i, item) {
                        if (item.id == id) {
                            item["chkDisabled"] = true;
                        }
                    })
                }
                return responseData.content;
            }
            function organizationOnCheck(event, treeId, treeNode) {
                $("#edit-department-name").attr("data-parentid", treeNode.id);
                $("#edit-upper-department-name-select").val(treeNode.name);
            }
            $.fn.zTree.init($("#edit-organization-list-select"), organizationSettings);
            e.preventDefault();
            var dialog = $( "#edit-department-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑部门</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this), flag = validateForm.form(), editDepartmentName = $("#edit-department-name");
                            if(flag){
                                var data = {
                                    "name": editDepartmentName.val(),
                                    "id": editDepartmentName.attr("data-id"),
                                    "parentid": editDepartmentName.attr("data-parentid")
                                };
                                $.ajax({
                                    url: contextPath+"api/dingtalkdept/",
                                    type: "put",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        organizationRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }
                        }
                    },
                    {
                        text: "删除",
                        "class" : "btn btn-danger btn-minier "+displayStyle,
                        click: function() {
                            var _this = $(this),
                                data = {
                                "id": $("#edit-department-name").attr("data-id")
                            };
                            $.ajax({
                                url: contextPath+"api/dingtalkdept/?id="+id,
                                type: "delete",
                                contentType: "application/json",
                                dataType : "json",
                                success: function (data) {
                                    organizationRefreshNode();
                                    _this.dialog( "close" );
                                },
                                error: function (data) {
//                                    console.log(data);
                                }
                            });
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });

        });

        //添加子部门
        var $form = $('#add-sub-department-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                name: {
                    required: true,
                    remote: function() {
                        var name = $("#add-sub-department-name").val();
                        var remote = {
                            url: contextPath+"api/dingtalkdept/eqname",
                            type: "get",
                            data: "eqname="+name
                        };
                        return remote;
                    }
                }
            },
            messages: {
                name:{
                    remote: "该部门已经存在"
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $( "#add-sub-department-btn" ).on('click', function(e) {
            validateResetForm($form, $('#add-sub-department-container>form'));
            $("#add-upper-department-name").val($(".department-name").text());
            $("#add-upper-department-id").val($(".department-name").attr("data-id"));
            e.preventDefault();
            var dialog = $( "#add-sub-department-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;添加部门</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $form.form();
                            if(flag){
                                var data = $('#add-sub-department-container>form').serializeObject();
                                $.ajax({
                                    url: contextPath+"api/dingtalkdept/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        organizationRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {

                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //添加部门成员
        var $formAddDepartmentStaff = $('#add-department-staff-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                username: {
                    required: true
                },
                departmentname: {
                    required: true
                },
                role: {
                    required: true
                },
                phone: {
                    required: true,
                    remote: function() {
                        var mobile = $("#add-department-staff-phone").val();
                        var r = {
                            url: contextPath+"api/dingtalkuser/mobile",
                            type: "get",
                            data: "mobile="+mobile
                        };
                        return r;
                    }
                },
                password: {
                    required: true,
                    minlength: 6
                },
                confirm_password: {
                    required: true,
                    equalTo: "#add-department-staff-repassword"
                }
            },
            messages: {
                phone: {
                    remote: "该用户已经存在"
                },
                password: {
                    minlength: "密码最少长度为6位"
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });

        $( "#add-department-staff-btn" ).on('click', function(e) {
            validateResetForm($formAddDepartmentStaff, $('#add-department-staff-container>form'));
            //选择部门
            var organizationSettings = {
                async: {
                    enable: true,
                    dataType: "json",
                    type: "get",
                    url: contextPath+"api/dingtalkdept/list",
                    dataFilter: ajaxDataFilterFns
                },
                data:{
                    key: {
                        name: "name"
                    },
                    simpleData : {
                        enable : true,
                        idKey: "id",
                        pIdKey: "parentid",
                        rootPId: 0
                    }
                },
                check: {
                    enable: true,
                    chkStyle: "checkbox",
                    chkboxType: { "Y" : "", "N" : "" }
                },
                view: {
                    showLine: false
                }
            };
            function ajaxDataFilterFns(treeId, parentNode, responseData) {
                if (responseData.content) {
                    $.each(responseData.content, function (i, item) {
                        if (item.id == $(".department-name").attr("data-id")) {
                            item["checked"] = true;
                        }
                    })
                }
                return responseData.content;
            }
            $.fn.zTree.init($("#add-department-staff-departmentname-select"), organizationSettings);
            $("#add-department-staff-departmentname-btn").unbind();
            $("#add-department-staff-departmentname-btn").on("click", function () {
                $("#departmentname-error").parents(".has-error").removeClass("has-error");
                $("#departmentname-error").remove();
                if ($("#add-department-staff-departmentname-select").hasClass("display-none")) {
                    $("#add-department-staff-departmentname-select").removeClass("display-none")
                } else {
                    $("#add-department-staff-departmentname-select").addClass("display-none")
                }
            });

            //选择角色
            var roleSettings = {
                async: {
                    enable: true,
                    dataType: "json",
                    type: "get",
                    url: contextPath+"api/sysrole/list",
                    dataFilter: ajaxDataFilterFn
                },
                data:{
                    key: {
                        name: "roleName"
                    },
                    simpleData : {
                        enable : false
                    }
                },
                check: {
                    enable: true,
                    chkStyle: "checkbox"
                },
                view: {
                    showLine: false
                }
            };
            $.fn.zTree.init($("#add-department-staff-role-select"), roleSettings);
            $("#add-department-staff-role-btn").unbind();
            $("#add-department-staff-role-btn").on("click", function () {
                $("#role-error").parents(".has-error").removeClass("has-error");
                $("#role-error").remove();
                if ($("#add-department-staff-role-select").hasClass("display-none")) {
                    $("#add-department-staff-role-select").removeClass("display-none")
                } else {
                    $("#add-department-staff-role-select").addClass("display-none")
                }
            });
            e.preventDefault();
            var dialog = $( "#add-department-staff-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '680',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;添加成员</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var treeObj = $.fn.zTree.getZTreeObj("add-department-staff-departmentname-select");
                            var nodes = treeObj.getCheckedNodes(true), departmentnameArr = [];
                            if (nodes.length) {
                                $("#add-department-staff-departmentname-btn").siblings("input").val("true");
                                $("#departmentname-error").parents(".has-error").removeClass("has-error");
                                $("#departmentname-error").remove();
                                $.each(nodes, function (i, item) {
                                    departmentnameArr.push({"id":item.id})
                                })
                            } else {
                                $("#add-department-staff-departmentname-btn").siblings("input").val("");
                            }
                            var treeObjtwo = $.fn.zTree.getZTreeObj("add-department-staff-role-select");
                            var nodestwo = treeObjtwo.getCheckedNodes(true), roleArr = [];
                            if (nodestwo.length) {
                                $("#add-department-staff-role-btn").siblings("input").val("true");
                                $("#role-error").parents(".has-error").removeClass("has-error");
                                $("#role-error").remove();
                                $.each(nodestwo, function (i, item) {
                                    roleArr.push({"roleId":item.roleId})
                                })
                            } else {
                                $("#add-department-staff-role-btn").siblings("input").val("");
                            }
                            var flag = $formAddDepartmentStaff.form();
                            if(flag){
                                var data = {
                                    "name": $("#add-department-staff-username").val(),
                                    "depts": departmentnameArr,
                                    "position": $("#add-department-staff-position").val(),
                                    "roles": roleArr,
                                    "jobnumber": $("#add-department-staff-jobnumber").val(),
                                    "mobile": $("#add-department-staff-phone").val(),
                                    "tel": $("#add-department-staff-tel").val(),
                                    "email": $("#add-department-staff-email").val(),
                                    "workplace": $("#add-department-staff-workplace").val(),
                                    "remark": $("#add-department-staff-remark").val(),
                                    "password": $("#add-department-staff-password").val()
                                };
                                $.ajax({
                                    url: contextPath+"api/dingtalkuser/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        $.ajax({
                                            async : false,
                                            cache:false,
                                            type: 'get',
                                            dataType : "json",
                                            contentType: "application/json",
                                            url: contextPath + "api/dingtalkdept/pid?pid="+$(".department-name").attr("data-id"),
                                            success:function(data){
                                                if (data.status == "200") {
                                                    //默认子级部门列表
                                                    var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                                                    subDepartmentOlBox.html('');
                                                    if (data.content.depts.length) {
                                                        var subDepartmentHtml = '';
                                                        $(".sub-department-queue").removeClass("display-none");
                                                        $.each(data.content.depts, function (i, item) {
                                                            subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                                                    '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                                                    '</li>';
                                                        });
                                                    } else {
                                                        $(".sub-department-queue").addClass("display-none");
                                                        subDepartmentHtml = '<div class="alert alert-info center">'+
                                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                                '<i class="ace-icon fa fa-times"></i>'+
                                                                '</button>'+
                                                                '当前部门不包含下级部门请添加子部门'+
                                                                '</div>';
                                                    }
                                                    subDepartmentOlBox.append(subDepartmentHtml);
                                                    //默认部门人员列表
                                                    departmentStaffBodyBox.html('');
                                                    if (data.content.users.length) {
                                                        var departmentStaffUserListHtml = '';
                                                        $.each(data.content.users, function (i, item) {
                                                            var checkedDisabled = "";
                                                            if (item.isAdmin) {
                                                                checkedDisabled = "disabled";
                                                            }
                                                            departmentStaffUserListHtml += '<tr>'+
                                                                    '<td>'+
                                                                    '<label class="pos-rel">'+
                                                                    '<input type="checkbox" '+ checkedDisabled +' data-id="'+ item.userid +'" data-del="'+ item.isAdmin +'" class="ace">'+
                                                                    '<span class="lbl"></span>'+
                                                                    '</label>'+
                                                                    '</td>'+
                                                                    '<td>'+ item.name +'</td>'+
                                                                    '<td>'+ item.position +'</td>'+
                                                                    '<td>'+ item.jobnumber +'</td>'+
                                                                    '<td>'+ item.mobile +'</td>'+
                                                                    '<td>'+ item.email +'</td>'+
                                                                    '<td data-id="'+ item.userid +'" data-isAdmin="'+ item.isAdmin +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-btn" title="编辑信息"></i>&nbsp;&nbsp;<i class="ace-icon fa fa-key bigger-110 icon-only change-password-btn" title="修改密码"></i></td>'+
                                                                    '</tr>';
                                                        });
                                                    } else {
                                                        departmentStaffUserListHtml = '<tr><td colspan="7">'+
                                                                '<div class="alert alert-info">'+
                                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                                '<i class="ace-icon fa fa-times"></i>'+
                                                                '</button>'+
                                                                '当前部门暂无人员请添加成员'+
                                                                '</div>'+
                                                                '</td></tr>';
                                                    }
                                                    departmentStaffBodyBox.append(departmentStaffUserListHtml);
                                                    $("#department-staff .edit-btn").on("click", function () {
                                                        var _this = $(this);
                                                        editDepartmentStaffInfo(_this.parents("td").attr("data-id"), _this.parents("td").attr("data-isAdmin"));
                                                    });
                                                    $(".change-password-btn").on("click", function () {
                                                        var _this = $(this);
                                                        changePassword(_this.parents("td").attr("data-id"))
                                                    });
                                                }
                                            },
                                            error: function () {
//                                                alert('请求失败');
                                            }
                                        });
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })
                            }
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //编辑部门成员
        var $formEditDepartmentStaff = $('#edit-department-staff-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                username: {
                    required: true
                },
                departmentname: {
                    required: true
                },
                role: {
                    required: true
                },
                /*phone: {
                    equired: true,
                    remote: function() {
                        var mobile = $("#edit-department-staff-phone").val();
                        var r = {
                            url: contextPath+"api/dingtalkuser/mobile",
                            type: "get",
                            data: "eqname="+mobile
                        };
                        return r;
                    }
                }*/
            },
            messages: {
                /*phone: {
                    remote: "该用户已经存在"
                }*/
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        function editDepartmentStaffInfo(id, isAdmin) {
            validateResetForm($formEditDepartmentStaff, $('#edit-department-staff-container>form'));
            var displayStyle = "display-none";
            if (isAdmin == "0") {
                displayStyle = "display-inlin-block";
            }
            $.ajax({
                url: contextPath+"api/dingtalkuser/?id="+id,
                type: "get",
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    var result = data.content, department = data.content.depts, roleList = data.content.roles;
                    $("#edit-department-staff-username").val(result.name);
                    $("#edit-department-staff-position").val(result.position);
                    $("#edit-department-staff-jobnumber").val(result.jobnumber);
                    $("#edit-department-staff-phone").val(result.mobile);
                    $("#edit-department-staff-tel").val(result.tel);
                    $("#edit-department-staff-email").val(result.email);
                    $("#edit-department-staff-workplace").val(result.workplace);
                    $("#edit-department-staff-remark").val(result.remark);
                    //选择部门
                    var organizationSettings = {
                        async: {
                            enable: true,
                            dataType: "json",
                            type: "get",
                            url: contextPath+"api/dingtalkdept/list",
                            dataFilter: ajaxDataFilterFns
                        },
                        data:{
                            key: {
                                name: "name"
                            },
                            simpleData : {
                                enable : true,
                                idKey: "id",
                                pIdKey: "parentid",
                                rootPId: 0
                            }
                        },
                        check: {
                            enable: true,
                            chkStyle: "checkbox",
                            chkboxType: { "Y" : "", "N" : "" }
                        },
                        view: {
                            showLine: false
                        }
                    };
                    function ajaxDataFilterFns(treeId, parentNode, responseData) {
                        if (responseData.content) {
                            if (department.length) {
                                $.each(department, function (j, jtem) {
                                    $.each(responseData.content, function (i, item) {
                                        if (item.id == jtem.id) {
                                            item["checked"] = true;
                                        }
                                    })
                                })
                            }
                        }
                        return responseData.content;
                    }
                    $.fn.zTree.init($("#edit-department-staff-departmentname-select"), organizationSettings);
                    $("#edit-department-staff-departmentname-btn").unbind();
                    $("#edit-department-staff-departmentname-btn").on("click", function () {
                        $("#departmentname-error").parents(".has-error").removeClass("has-error");
                        $("#departmentname-error").remove();
                        if ($("#edit-department-staff-departmentname-select").hasClass("display-none")) {
                            $("#edit-department-staff-departmentname-select").removeClass("display-none")
                        } else {
                            $("#edit-department-staff-departmentname-select").addClass("display-none")
                        }
                    });

                    //选择角色
                    var roleSettings = {
                        async: {
                            enable: true,
                            dataType: "json",
                            type: "get",
                            url: contextPath+"api/sysrole/list",
                            dataFilter: ajaxDataFilterFnSettings
                        },
                        data:{
                            key: {
                                name: "roleName"
                            },
                            simpleData : {
                                enable : false
                            }
                        },
                        check: {
                            enable: true,
                            chkStyle: "checkbox"
                        },
                        view: {
                            showLine: false
                        }
                    };
                    function ajaxDataFilterFnSettings(treeId, parentNode, responseData) {
                        if (responseData.content) {
                            if (roleList.length) {
                                $.each(roleList, function (j, jtem) {
                                    $.each(responseData.content, function (i, item) {
                                        if (item.roleId == jtem.roleId) {
                                            item["checked"] = true;
                                        }
                                    })
                                })
                            }
                        }
                        return responseData.content;
                    }
                    $.fn.zTree.init($("#edit-department-staff-role-select"), roleSettings);
                    $("#edit-department-staff-role-btn").unbind();
                    $("#edit-department-staff-role-btn").on("click", function () {
                        $("#role-error").parents(".has-error").removeClass("has-error");
                        $("#role-error").remove();
                        if ($("#edit-department-staff-role-select").hasClass("display-none")) {
                            $("#edit-department-staff-role-select").removeClass("display-none")
                        } else {
                            $("#edit-department-staff-role-select").addClass("display-none")
                        }
                    });
                },
                error: function (data) {
//                    console.log(data);
                }
            });
            var dialog = $( "#edit-department-staff-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '680',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑成员</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var treeObj = $.fn.zTree.getZTreeObj("edit-department-staff-departmentname-select");
                            var nodes = treeObj.getCheckedNodes(true), departmentnameArr = [];
                            if (nodes.length) {
                                $("#edit-department-staff-departmentname-btn").siblings("input").val("true");
                                $("#departmentname-error").parents(".has-error").removeClass("has-error");
                                $("#departmentname-error").remove();
                                $.each(nodes, function (i, item) {
                                    departmentnameArr.push({"id":item.id})
                                })
                            } else {
                                $("#edit-department-staff-departmentname-btn").siblings("input").val("");
                            }
                            var treeObjtwo = $.fn.zTree.getZTreeObj("edit-department-staff-role-select");
                            var nodestwo = treeObjtwo.getCheckedNodes(true), roleArr = [];
                            if (nodestwo.length) {
                                $("#edit-department-staff-role-btn").siblings("input").val("true");
                                $("#role-error").parents(".has-error").removeClass("has-error");
                                $("#role-error").remove();
                                $.each(nodestwo, function (i, item) {
                                    roleArr.push({"roleId":item.roleId})
                                })
                            } else {
                                $("#edit-department-staff-role-btn").siblings("input").val("");
                            }
                            var flag = $formEditDepartmentStaff.form();
                            if(flag){
                                var data = {
                                    "userid": id,
                                    "name": $("#edit-department-staff-username").val(),
                                    "depts": departmentnameArr,
                                    "position": $("#edit-department-staff-position").val(),
                                    "roles": roleArr,
                                    "jobnumber": $("#edit-department-staff-jobnumber").val(),
                                    "mobile": $("#edit-department-staff-phone").val(),
                                    "tel": $("#edit-department-staff-tel").val(),
                                    "email": $("#edit-department-staff-email").val(),
                                    "workplace": $("#edit-department-staff-workplace").val(),
                                    "remark": $("#edit-department-staff-remark").val()
                                };
                                $.ajax({
                                    url: contextPath+"api/dingtalkuser/",
                                    type: "put",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        $.ajax({
                                            async : false,
                                            cache:false,
                                            type: 'get',
                                            dataType : "json",
                                            contentType: "application/json",
                                            url: contextPath + "api/dingtalkdept/pid?pid="+$(".department-name").attr("data-id"),
                                            success:function(data){
                                                if (data.status == "200") {
                                                    //默认子级部门列表
                                                    var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                                                    subDepartmentOlBox.html('');
                                                    if (data.content.depts.length) {
                                                        var subDepartmentHtml = '';
                                                        $(".sub-department-queue").removeClass("display-none");
                                                        $.each(data.content.depts, function (i, item) {
                                                            subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                                                    '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                                                    '</li>';
                                                        });
                                                    } else {
                                                        $(".sub-department-queue").addClass("display-none");
                                                        subDepartmentHtml = '<div class="alert alert-info center">'+
                                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                                '<i class="ace-icon fa fa-times"></i>'+
                                                                '</button>'+
                                                                '当前部门不包含下级部门请添加子部门'+
                                                                '</div>';
                                                    }
                                                    subDepartmentOlBox.append(subDepartmentHtml);
                                                    //默认部门人员列表
                                                    departmentStaffBodyBox.html('');
                                                    if (data.content.users.length) {
                                                        var departmentStaffUserListHtml = '';
                                                        $.each(data.content.users, function (i, item) {
                                                            var checkedDisabled = "";
                                                            if (item.isAdmin) {
                                                                checkedDisabled = "disabled";
                                                            }
                                                            departmentStaffUserListHtml += '<tr>'+
                                                                    '<td>'+
                                                                    '<label class="pos-rel">'+
                                                                    '<input type="checkbox" '+ checkedDisabled +' data-id="'+ item.userid +'" data-del="'+ item.isAdmin +'" class="ace">'+
                                                                    '<span class="lbl"></span>'+
                                                                    '</label>'+
                                                                    '</td>'+
                                                                    '<td>'+ item.name +'</td>'+
                                                                    '<td>'+ item.position +'</td>'+
                                                                    '<td>'+ item.jobnumber +'</td>'+
                                                                    '<td>'+ item.mobile +'</td>'+
                                                                    '<td>'+ item.email +'</td>'+
                                                                    '<td data-id="'+ item.userid +'" data-isAdmin="'+ item.isAdmin +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-btn" title="编辑信息"></i>&nbsp;&nbsp;<i class="ace-icon fa fa-key bigger-110 icon-only change-password-btn" title="修改密码"></i></td>'+
                                                                    '</tr>';
                                                        });
                                                    } else {
                                                        departmentStaffUserListHtml = '<tr><td colspan="7">'+
                                                                '<div class="alert alert-info">'+
                                                                '<button type="button" class="close" data-dismiss="alert">'+
                                                                '<i class="ace-icon fa fa-times"></i>'+
                                                                '</button>'+
                                                                '当前部门暂无人员请添加成员'+
                                                                '</div>'+
                                                                '</td></tr>';
                                                    }
                                                    departmentStaffBodyBox.append(departmentStaffUserListHtml);
                                                    $("#department-staff .edit-btn").on("click", function () {
                                                        var _this = $(this);
                                                        editDepartmentStaffInfo(_this.parents("td").attr("data-id"), _this.parents("td").attr("data-isAdmin"));
                                                    });
                                                    $(".change-password-btn").on("click", function () {
                                                        var _this = $(this);
                                                        changePassword(_this.parents("td").attr("data-id"))
                                                    });
                                                }
                                            },
                                            error: function () {
//                                                alert('请求失败');
                                            }
                                        });
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })
                            }
                        }
                    },
                    {
                        text: "删除",
                        "class" : "btn btn-danger btn-minier "+displayStyle,
                        click: function() {
                            var _this = $(this);
                            $.ajax({
                                url: contextPath+"dingtalkuser/batch",
                                type: "delete",
                                data : JSON.stringify([id]),
                                contentType: "application/json",
                                dataType : "json",
                                success: function (data) {
                                    organizationRefreshNode();
                                    _this.dialog( "close" );
                                },
                                error: function (data) {
//                                    console.log(data);
                                }
                            });
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        }
        //修改用户密码
        var $formChangePassword = $('#change-password-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                password: {
                    required: true,
                    minlength: 6
                },
                confirm_password: {
                    required: true,
                    equalTo: "#change-password-password"
                }
            },
            messages: {
                password: {
                    minlength: "密码最少长度为6位"
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        function changePassword(id) {
            validateResetForm($formChangePassword, $('#change-password-container>form'));
            var dialog = $( "#change-password-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '680',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;修改密码</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formChangePassword.form();

                            if(flag){
                                $.ajax({
                                    url: contextPath+"api/dingtalkuser/editPwd?id="+ id +"&pwd="+$("#change-password-password").val(),
                                    type: "put",
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })
                            }
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        }
        
        //批量删除部门成员
        //选所有checkbox
        $(".department-staff-head .checkbox-all").on("click", function () {
            var departmentStaffBodyTr = $(".department-staff-body tr");
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
                departmentStaffBodyTr.find("td input[type=checkbox]").prop('checked', false)
            } else {
                $(this).addClass("active");
                departmentStaffBodyTr.find("td input[type=checkbox]:not(:disabled)").prop('checked', true)
            }
        });
        $("#add-department-staff-del-btn").on("click", function () {
            var selectBoxlist = $(".department-staff-body input:checkbox:checked"), data = [];
            if (selectBoxlist.length) {
                selectBoxlist.each(function (i, item) {
                    if (!$(item).attr("disabled")) {
                        data.push($(item).attr("data-id"))
                    }
                })
            }
            $.ajax({
                url: contextPath+"api/dingtalkuser/batch",
                type: "delete",
                data : JSON.stringify(data),
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    $.ajax({
                        async : false,
                        cache:false,
                        type: 'get',
                        dataType : "json",
                        contentType: "application/json",
                        url: contextPath + "api/dingtalkdept/pid?pid="+$(".department-name").attr("data-id"),
                        success:function(data){
                            if (data.status == "200") {
                                //默认子级部门列表
                                var subDepartmentOlBox = $("#sub-department>ol"), departmentStaffBodyBox = $(".department-staff-body");
                                subDepartmentOlBox.html('');
                                if (data.content.depts.length) {
                                    var subDepartmentHtml = '';
                                    $(".sub-department-queue").removeClass("display-none");
                                    $.each(data.content.depts, function (i, item) {
                                        subDepartmentHtml += '<li class="dd-item" data-id='+ item.id +'>'+
                                                '<div class="dd-handle"><i></i>&nbsp;'+ item.name + '（'+ item.memberCount +'人）</div>'+
                                                '</li>';
                                    });
                                } else {
                                    $(".sub-department-queue").addClass("display-none");
                                    subDepartmentHtml = '<div class="alert alert-info center">'+
                                            '<button type="button" class="close" data-dismiss="alert">'+
                                            '<i class="ace-icon fa fa-times"></i>'+
                                            '</button>'+
                                            '当前部门不包含下级部门请添加子部门'+
                                            '</div>';
                                }
                                subDepartmentOlBox.append(subDepartmentHtml);
                                //默认部门人员列表
                                departmentStaffBodyBox.html('');
                                if (data.content.users.length) {
                                    var departmentStaffUserListHtml = '';
                                    $.each(data.content.users, function (i, item) {
                                        var checkedDisabled = "";
                                        if (item.isAdmin) {
                                            checkedDisabled = "disabled";
                                        }
                                        departmentStaffUserListHtml += '<tr>'+
                                                '<td>'+
                                                '<label class="pos-rel">'+
                                                '<input type="checkbox" '+ checkedDisabled +' data-id="'+ item.userid +'" data-del="'+ item.isAdmin +'" class="ace">'+
                                                '<span class="lbl"></span>'+
                                                '</label>'+
                                                '</td>'+
                                                '<td>'+ item.name +'</td>'+
                                                '<td>'+ item.position +'</td>'+
                                                '<td>'+ item.jobnumber +'</td>'+
                                                '<td>'+ item.mobile +'</td>'+
                                                '<td>'+ item.email +'</td>'+
                                                '<td data-id="'+ item.userid +'" data-isAdmin="'+ item.isAdmin +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-btn" title="编辑信息"></i>&nbsp;&nbsp;<i class="ace-icon fa fa-key bigger-110 icon-only change-password-btn" title="修改密码"></i></td>'+
                                                '</tr>';
                                    });
                                } else {
                                    departmentStaffUserListHtml = '<tr><td colspan="7">'+
                                            '<div class="alert alert-info">'+
                                            '<button type="button" class="close" data-dismiss="alert">'+
                                            '<i class="ace-icon fa fa-times"></i>'+
                                            '</button>'+
                                            '当前部门暂无人员请添加成员'+
                                            '</div>'+
                                            '</td></tr>';
                                }
                                departmentStaffBodyBox.append(departmentStaffUserListHtml);
                                $("#department-staff .edit-btn").on("click", function () {
                                    var _this = $(this);
                                    editDepartmentStaffInfo(_this.parents("td").attr("data-id"), _this.parents("td").attr("data-isAdmin"));
                                });
                                $(".change-password-btn").on("click", function () {
                                    var _this = $(this);
                                    changePassword(_this.parents("td").attr("data-id"))
                                });
                            }
                        },
                        error: function () {
//                            alert('请求失败');
                        }
                    });
                },
                error: function (data) {
//                    console.log(data);
                }
            })
        });


        //获取角色列表
        var roleSettings = {
            async: {
                enable: true,
                dataType: "json",
                type: "get",
                url: contextPath+"api/sysrolegroup/list",
                dataFilter: ajaxDataFilterFn
            },
            data:{
                key: {
                    name: "roleName"
                },
                simpleData : {
                    enable : false
                }
            },
            callback: {
                onAsyncSuccess: roleOnAsyncSuccessFn,
                onClick: roleOnClick
            },
            view: {
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom,
                showLine: false
            }
        };
        function roleOnAsyncSuccessFn(event, treeId, treeNode, msg) {
            // 角色组
            if (msg.content.length) {
                $("#add-role-person-group").html('<option value="" disabled="" selected="" class="first-option">请选择角色组</option>');
                var addRoleRersonGroupBox = $("#add-role-person-group .first-option"), addRoleRersonGroupHtml = '';
                $.each(msg.content, function (i, item) {
                    addRoleRersonGroupHtml += '<option value="'+ item.roleId +'">'+ item.roleName +'</option>'
                });
                $(addRoleRersonGroupHtml).insertAfter(addRoleRersonGroupBox[0])
            }

        }
        function roleOnClick(event, treeId, treeNode) {
            if (!treeNode.isParent) {
                roleContainer.find("h3, .role-group-person-list").removeClass("display-none");
                roleContainer.find(".defaultHtml").remove();
                $("#role-person-name").text(treeNode.roleName);
                var id = treeNode.roleId;
                $("#edit-role-person-btn").attr("data-roleId", treeNode.roleId).attr("data-isDel", treeNode.isDel);
                $.ajax({
                    async : false,
                    cache:false,
                    type: 'get',
                    dataType : "json",
                    contentType: "application/json",
                    url: contextPath + "api/dingtalkuser/role?roleid="+id,
                    success:function(data){
                        if (data.status == "200") {
                            //角色人员列表
                            $("#role-group-person-list>tbody").html('');
                             if (data.content.length) {
                                 var roleGroupPersonListHtml = '';
                                 $.each(data.content, function (i, item) {
                                     var checkedDisabled = "";
                                     if (item.isAdmin) {
                                         checkedDisabled = "disabled";
                                     }
                                     roleGroupPersonListHtml += '<tr class="align-center">'+
                                         '<td>'+
                                             '<label class="pos-rel">'+
                                             '<input type="checkbox" class="ace" data-id="'+ item.userid +'" '+ checkedDisabled +'>'+
                                             '<span class="lbl"></span>'+
                                             '</label>'+
                                         '</td>'+
                                         '<td>'+ item.name +'</td>'+
                                         '<td>'+ item.position +'</td>'+
                                         '<td>'+ item.jobnumber +'</td>'+
                                     '</tr>';
                                 });
                             } else {
                                 roleGroupPersonListHtml = '<tr><td colspan="4">'+
                                 '<div class="alert alert-info">'+
                                     '<button type="button" class="close" data-dismiss="alert">'+
                                     '<i class="ace-icon fa fa-times"></i>'+
                                     '</button>'+
                                     '当前角色暂无人员请添加成员'+
                                 '</div>'+
                                 '</td>' +
                             '</tr>';
                             }
                             $("#role-group-person-list>tbody").append(roleGroupPersonListHtml);
                        }
                    },
                    error: function () {
//                        alert('请求失败');
                    }
                });
            }

        }
        function roleRefreshNode() {
            var zTree = $.fn.zTree.getZTreeObj("role-list");
            zTree.reAsyncChildNodes(null, "refresh");
        }
        var $formEditRoleGroup = $('#edit-role-group-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                roleName: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        function addHoverDom(treeId, treeNode) {
            if (treeNode.isParent && !treeNode.isDel) {
                var aObj = $("#" + treeNode.tId + "_a");
                if ($("#diyBtn_"+treeNode.roleId).length>0) return;
                var editStr = "<span id='diyBtn_space_" +treeNode.roleId+ "' > </span>"
                        + "<button type='button' class='btn btn-white btn-sm btn-primary' id='diyBtn_" + treeNode.roleId
                        + "' onfocus='this.blur();'>编辑</button>";
                aObj.append(editStr);
                var btn = $("#diyBtn_"+treeNode.roleId), displayStyle = "display-none", roleId = treeNode.roleId;
                if (btn) btn.bind("click", function(){
                    validateResetForm($formEditRoleGroup, $('#edit-role-group-container>form'));
                    //编辑角色组
                    $("#edit-role-group-name").val(treeNode.roleName);
                    if (!treeNode.isDel) {
                        displayStyle = "display-inlin-block";
                    }
                    var dialog = $( "#edit-role-group-container" ).removeClass('hide').dialog({
                        dragStop: function( event, ui ) {
                            $(event.target.offsetParent).css("height", "auto");
                        },
                        resizable: false,
                        width: '600',
                        height: 'auto',
                        modal: true,
                        closeText: "关闭",
                        title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑角色组</h4></div>",
                        title_html: true,
                        buttons: [
                            {
                                text: "保存",
                                "class" : "btn btn-info btn-minier",
                                click: function() {
                                    var _this = $(this);
                                    var flag = $formEditRoleGroup.form();
                                    if(flag){
                                        var data = {
                                            "roleName": $("#edit-role-group-name").val(),
                                            "roleId": roleId
                                        };
                                        $.ajax({
                                            url: contextPath+"api/sysrolegroup",
                                            type: "put",
                                            data : JSON.stringify(data),
                                            contentType: "application/json",
                                            dataType : "json",
                                            success: function (data) {
                                                roleRefreshNode();
                                                _this.dialog( "close" );
                                            },
                                            error: function (data) {
//                                                console.log(data);
                                            }
                                        })

                                    }


                                }
                            },
                            {
                                text: "删除",
                                "class" : "btn btn-danger btn-minier "+displayStyle,
                                click: function() {
                                    var _this = $(this);
                                    $.ajax({
                                        url: contextPath+"api/sysrolegroup/?id="+roleId,
                                        type: "delete",
                                        contentType: "application/json",
                                        dataType : "json",
                                        success: function (data) {
                                            roleRefreshNode();
                                            _this.dialog( "close" );
                                        },
                                        error: function (data) {
//                                            console.log(data);
                                        }
                                    });
                                }
                            },
                            {
                                text: "取消",
                                "class" : "btn btn-minier",
                                click: function() {
                                    $( this ).dialog( "close" );
                                }
                            }
                        ]
                    });
                });
            }

        }
        function removeHoverDom(treeId, treeNode) {
            $("#diyBtn_"+treeNode.roleId).unbind().remove();
            $("#diyBtn_space_" +treeNode.roleId).unbind().remove();
        }
        $.fn.zTree.init($("#role-list"), roleSettings);

        //角色成员批量删除
        $(".role-group-person-list-head .checkbox-all").on("click", function () {
            var roleGroupPersonListBodyTr = $(".role-group-person-list-body tr");
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
                roleGroupPersonListBodyTr.find("td input[type=checkbox]").prop('checked', false)
            } else {
                $(this).addClass("active");
                roleGroupPersonListBodyTr.find("td input[type=checkbox]:not(:disabled)").prop('checked', true)
            }
        });
        $("#role-group-person-list-del").on("click", function () {
            var selectBoxlist = $(".role-group-person-list-body input:checkbox:checked"), data = [];
            if (selectBoxlist.length) {
                selectBoxlist.each(function (i, item) {
                    if (!$(item).attr("disabled")) {
                        data.push($(item).attr("data-id"))
                    }
                })
            }
            $.ajax({
                url: contextPath+"api/sysuserrole/batch",
                type: "delete",
                data : JSON.stringify(data),
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    $.ajax({
                        async : false,
                        cache:false,
                        type: 'get',
                        dataType : "json",
                        contentType: "application/json",
                        url: contextPath + "api/dingtalkuser/role?roleid="+$("#role-person-name").siblings("button").attr("data-roleid"),
                        success:function(data){
                            if (data.status == "200") {
                                //角色人员列表
                                $("#role-group-person-list>tbody").html('');
                                if (data.content.length) {
                                    var roleGroupPersonListHtml = '';
                                    $.each(data.content, function (i, item) {
                                        var checkedDisabled = "";
                                        if (item.isAdmin) {
                                            checkedDisabled = "disabled";
                                        }
                                        roleGroupPersonListHtml += '<tr class="align-center">'+
                                                '<td>'+
                                                '<label class="pos-rel">'+
                                                '<input type="checkbox" class="ace" data-id="'+ item.userid +'" '+ checkedDisabled +'>'+
                                                '<span class="lbl"></span>'+
                                                '</label>'+
                                                '</td>'+
                                                '<td>'+ item.name +'</td>'+
                                                '<td>'+ item.position +'</td>'+
                                                '<td>'+ item.jobnumber +'</td>'+
                                                '</tr>';
                                    });
                                } else {
                                    roleGroupPersonListHtml = '<tr><td colspan="4">'+
                                            '<div class="alert alert-info">'+
                                            '<button type="button" class="close" data-dismiss="alert">'+
                                            '<i class="ace-icon fa fa-times"></i>'+
                                            '</button>'+
                                            '当前角色暂无人员请添加成员'+
                                            '</div>'+
                                            '</td>' +
                                            '</tr>';
                                }
                                $("#role-group-person-list>tbody").append(roleGroupPersonListHtml);
                            }
                        },
                        error: function () {
//                            alert('请求失败');
                        }
                    });
                },
                error: function (data) {
//                    console.log(data);
                }
            })
        });

        // 新增角色组
        var $formAddRoleGroup = $('#add-role-group-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                roleName: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $(".add-role-group-btn").on("click", function () {
            validateResetForm($formAddRoleGroup, $('#add-role-group-container>form'));
            var dialog = $( "#add-role-group-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;新增角色组</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formAddRoleGroup.form();
                            if(flag){
                                var data = $('#add-role-group-container>form').serializeObject();
                                $.ajax({
                                    url: contextPath+"api/sysrolegroup",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        roleRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //获取权限
        var competenceSettings = {
            async: {
                enable: true,
                dataType: "json",
                type: "get",
                url: contextPath+"api/sysmenu/list",
                dataFilter: ajaxDataFilterFn
            },
            data:{
                key: {
                    name: "menuName"
                },
                simpleData : {
                    enable : true,
                    idKey: "menuId",
                    pIdKey: "menuParentId",
                    rootPId: 0
                }
            },
            view: {
                showLine: false
            },
            check: {
                enable: true,
                chkStyle: "checkbox"
            }
        };
        $.fn.zTree.init($("#add-role-person-competence-select"), competenceSettings);
        $("#add-role-person-rcompetence").on("click", function () {
            if ($("#add-role-person-competence-select").hasClass("display-none")) {
                $("#add-role-person-competence-select").removeClass("display-none")
            } else {
                $("#add-role-person-competence-select").addClass("display-none");
            }

        });


        //新增角色
        var $formAddRolePerson = $('#add-role-person-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                roleName: {
                    required: true
                },
                groupId: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $(".add-role-person-btn").on("click", function () {
            validateResetForm($formAddRolePerson, $('#add-role-person-container>form'));
            var dialog = $( "#add-role-person-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;新增角色</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formAddRolePerson.form();
                            if(flag){
                                var treeObj = $.fn.zTree.getZTreeObj("add-role-person-competence-select");
                                var nodes = treeObj.getCheckedNodes(true), menuIdArr = [];
                                if (nodes.length) {
                                    $.each(nodes, function (i, item) {
                                        menuIdArr.push({"menuId": item.menuId})
                                    })
                                }
                                var data = {
                                            "roleName": $("#add-role-person-name").val(),
                                            "groupId":$("#add-role-person-group").val(),
                                            "menus": menuIdArr
                                        }
                                        ;
                                $.ajax({
                                    url: contextPath+"api/sysrole/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        roleRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });
        
        //编辑角色
        var $formEditRolePerson = $('#edit-role-person-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                roleName: {
                    required: true
                },
                groupId: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $("#edit-role-person-btn").on("click", function () {
            validateResetForm($formEditRolePerson, $('#edit-role-person-container>form'));
            var _this = $(this), roleId = _this.attr("data-roleId"), groupId = "", displayStyle = "";
            if ($(this).attr("data-isDel") != "0") {
                displayStyle = "display-none";
                $("#edit-role-person-group").attr("disabled", "disabled");
            } else {
                displayStyle = "display-inlin-block";
                $("#edit-role-person-group").removeAttr("disabled");

            }
            $("#edit-role-person-rcompetence").unbind();
            $("#edit-role-person-rcompetence").on("click", function () {
                if ($("#edit-role-person-competence-select").hasClass("display-none")) {
                    $("#edit-role-person-competence-select").removeClass("display-none")
                } else {
                    $("#edit-role-person-competence-select").addClass("display-none");
                }

            });
            //权限初始化 edit-role-person-competence-select
            $.ajax({
                asysnc: false,
                url: contextPath+"api/sysrole/?id="+roleId,
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    if (data.status == "200") {
                        groupId = data.content.groupId;
                        $("#edit-role-person-name").val(data.content.roleName);
                        if (data.content.menus) {
                            var competenceSettings = {
                                async: {
                                    enable: true,
                                    dataType: "json",
                                    type: "get",
                                    url: contextPath+"api/sysmenu/list",
                                    dataFilter: competenceAjaxDataFilterFn
                                },
                                data:{
                                    key: {
                                        name: "menuName"
                                    },
                                    simpleData : {
                                        enable : true,
                                        idKey: "menuId",
                                        pIdKey: "menuParentId",
                                        rootPId: 0
                                    }
                                },
                                view: {
                                    showLine: false
                                },
                                check: {
                                    enable: true,
                                    chkStyle: "checkbox"
                                }
                            };
                            $.fn.zTree.init($("#edit-role-person-competence-select"), competenceSettings);
                            function competenceAjaxDataFilterFn(treeId, parentNode, responseData) {
                                if (responseData.content) {
                                    $.each(responseData.content, function (i, item) {
                                        $.each(data.content.menus, function (j, jtem) {
                                            if (item.menuId == jtem.menuId) {
                                                item["checked"] = true;
                                            }
                                        })
                                    });
                                    return responseData.content;
                                }
                            }
                        }

                        //角色组
                        var treeObj = $.fn.zTree.getZTreeObj("role-list");
                        var nodes = treeObj.getNodes();
                        if (nodes) {
                            var editRoleRersonGroupBox = $("#edit-role-person-group"), editRoleRersonGroupHtml = '';
                            editRoleRersonGroupBox.html("");
                            $.each(nodes, function (i, item) {
                                if (groupId == item.roleId) {
                                    editRoleRersonGroupHtml += '<option value="'+ item.roleId +'" selected>'+ item.roleName +'</option>'
                                } else {
                                    editRoleRersonGroupHtml += '<option value="'+ item.roleId +'">'+ item.roleName +'</option>'
                                }
                            });
                            editRoleRersonGroupBox.append(editRoleRersonGroupHtml);
                        }
                    }
                },
                error: function (data) {
//                    console.log(data);
                }
            });

            var dialog = $( "#edit-role-person-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑角色</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formEditRolePerson.form();
                            if(flag){
                                var treeObj = $.fn.zTree.getZTreeObj("edit-role-person-competence-select");
                                var nodes = treeObj.getCheckedNodes(true), menuIdArr = [];
                                if (nodes.length) {
                                    $.each(nodes, function (i, item) {
                                        menuIdArr.push({"menuId": item.menuId})
                                    })
                                }
                                var data = {
                                    "roleName": $("#edit-role-person-name").val(),
                                    "roleId": roleId,
                                    "groupId": $("#edit-role-person-group").val(),
                                    "menus": menuIdArr
                                };
                                $.ajax({
                                    url: contextPath+"api/sysrole/",
                                    type: "put",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        roleRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "删除",
                        "class" : "btn btn-danger btn-minier "+displayStyle,
                        click: function() {
                            var _this = $(this),
                                    data = {
                                        "id": $("#edit-department-name").attr("data-id")
                                    };
                            $.ajax({
                                url: contextPath+"api/sysrole/?id="+roleId,
                                type: "delete",
                                contentType: "application/json",
                                dataType : "json",
                                success: function (data) {
                                    roleRefreshNode();
                                    _this.dialog( "close" );
                                },
                                error: function (data) {
//                                    console.log(data);
                                }
                            });
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });



        /* 外部联系人 */
        //获取角色列表
        var tagSettings = {
            async: {
                enable: true,
                dataType: "json",
                type: "get",
                url: contextPath+"api/labgroup/list",
                dataFilter: ajaxDataFilterFn
            },
            data:{
                key: {
                    name: "name"
                },
                simpleData : {
                    enable : false
                }
            },
            callback: {
                onAsyncSuccess: tagOnAsyncSuccessFn,
                onClick: tagOnClick
            },
            view: {
                addHoverDom: tagAddHoverDom,
                removeHoverDom: tagRemoveHoverDom,
                showLine: false
            }
        };
        function tagOnAsyncSuccessFn(event, treeId, treeNode, msg) {
            if (msg.content.length) { //add-tag-group
                //初始化选择标签组
                var adTagGroupBox = $("#add-tag-container #add-tag-group, #edit-tag-container #edit-tag-group"), adTagGroupHtml = '';
                adTagGroupBox.html("");
                $.each(msg.content, function (i, item) {
                    adTagGroupHtml += '<option value="'+ item.id +'">'+ item.name +'</option>'
                });
                adTagGroupBox.append(adTagGroupHtml);
            }
        }
        function tagOnClick(event, treeId, treeNode) {
            if (treeNode.gid) {
                $(".outcontacts-container .widget-header, .outcontacts-container .widget-body").removeClass("display-none");
                $(".outcontacts-container").attr("data-labid", treeNode.id);
                $.ajax({
                    async : false,
                    cache:false,
                    type: 'get',
                    dataType : "json",
                    contentType: "application/json",
                    url: contextPath + "api/extcon/labid?labid="+treeNode.id,
                    success:function(data){
                        if (data.status == "200") {
                            //人员列表
                            $("#outcontacts-list>tbody").html('');
                            if (data.content.length) {
                                var outcontactsListHtml = '';
                                $.each(data.content, function (i, item) {
                                    outcontactsListHtml += '<tr class="align-center">'+
                                            '<td>'+
                                            '<label class="pos-rel">'+
                                            '<input type="checkbox" class="ace" data-id="'+ item.id +'">'+
                                            '<span class="lbl"></span>'+
                                            '</label>'+
                                            '</td>'+
                                            '<td>'+ item.username +'</td>'+
                                            '<td>'+ item.tel +'</td>'+
                                            '<td>'+ item.company +'</td>'+
                                            '<td>'+ item.changeUser.name +'</td>'+
                                            '<td data-id="'+ item.id +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-outcontacts-btn" title="编辑信息"></i></td>'+
                                            '</tr>';
                                });
                            } else {
                                outcontactsListHtml = '<tr><td colspan="6">'+
                                        '<div class="alert alert-info">'+
                                        '<button type="button" class="close" data-dismiss="alert">'+
                                        '<i class="ace-icon fa fa-times"></i>'+
                                        '</button>'+
                                        '当前暂无人员请添加成员'+
                                        '</div>'+
                                        '</td>' +
                                        '</tr>';
                            }
                            $("#outcontacts-list>tbody").append(outcontactsListHtml);

                            //编辑外部联系人
                            $(".edit-outcontacts-btn").on("click", function () {
                                editOutcontacts($(this).parent().attr("data-id"));
                            });
                        }
                    },
                    error: function () {
//                        alert('请求失败');
                    }
                });
            } else {
                $(".outcontacts-container .widget-header, .outcontacts-container .widget-body").addClass("display-none");
            }

        }
        function tagRefreshNode() {
            var zTree = $.fn.zTree.getZTreeObj("tag-list");
            zTree.reAsyncChildNodes(null, "refresh");
        }
        var $formEditTagGroup = $('#edit-tag-group-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                tagName: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        function tagAddHoverDom(treeId, treeNode) {
            var aObj = $("#" + treeNode.tId + "_a");
            if ($("#diyBtn_"+treeNode.id).length>0) return;
            var editStr = "<span id='diyBtn_space_" +treeNode.id+ "' > </span>"
                    + "<button type='button' class='btn btn-white btn-sm btn-primary' id='diyBtn_" + treeNode.id
                    + "' onfocus='this.blur();'>编辑</button>";
            aObj.append(editStr);
            var btn = $("#diyBtn_"+treeNode.id), id = treeNode.id;
            if (btn) btn.bind("click", function(){
                validateResetForm($formEditTagGroup, $('#edit-tag-group-container>form'));
                //编辑标签组
                if (!treeNode.gid) {
                    $("#edit-tag-group-name").val(treeNode.name);
                    var dialog = $( "#edit-tag-group-container" ).removeClass('hide').dialog({
                        dragStop: function( event, ui ) {
                            $(event.target.offsetParent).css("height", "auto");
                        },
                        resizable: false,
                        width: '600',
                        height: 'auto',
                        modal: true,
                        closeText: "关闭",
                        title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑标签组</h4></div>",
                        title_html: true,
                        buttons: [
                            {
                                text: "保存",
                                "class" : "btn btn-info btn-minier",
                                click: function() {
                                    var _this = $(this);
                                    var flag = $formEditTagGroup.form();
                                    if(flag){
                                        var data = {
                                            "id": id,
                                            "name": $("#edit-tag-group-name").val()
                                        };
                                        $.ajax({
                                            url: contextPath+"api/labgroup/",
                                            type: "put",
                                            data : JSON.stringify(data),
                                            contentType: "application/json",
                                            dataType : "json",
                                            success: function (data) {
                                                tagRefreshNode();
                                                _this.dialog( "close" );
                                            },
                                            error: function (data) {
//                                                console.log(data);
                                            }
                                        })

                                    }


                                }
                            },
                            {
                                text: "删除",
                                "class" : "btn btn-danger btn-minier ",
                                click: function() {
                                    var _this = $(this);
                                    $.ajax({
                                        url: contextPath+"api/labgroup/?id="+id,
                                        type: "delete",
                                        contentType: "application/json",
                                        dataType : "json",
                                        success: function (data) {
                                            tagRefreshNode();
                                            _this.dialog( "close" );
                                        },
                                        error: function (data) {
//                                            console.log(data);
                                        }
                                    });
                                }
                            },
                            {
                                text: "取消",
                                "class" : "btn btn-minier",
                                click: function() {
                                    $( this ).dialog( "close" );
                                }
                            }
                        ]
                    });
                } else {
                    //编辑标签
                    $("#edit-tag-name").val(treeNode.name);
                    var optionList = $("#edit-tag-group option");
                    optionList.each(function (i, item) {
                        if ($(item).attr("value") == treeNode.gid) {
                            $(item).attr("selected","selected")
                        }
                    });
                    var $formEditTag = $('#edit-tag-container>form').validate({
                        errorElement: 'span',
                        errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
                        focusInvalid: false,
                        ignore: "",
                        rules: {
                            tagName: {
                                required: true
                            }
                        },
                        highlight: function (e) {
                            $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
                        },
                        success: function (e) {
                            $(e).closest('.form-group').removeClass('has-error');
                            $(e).remove();
                        },
                        errorPlacement: function (error, element) {
                            error.insertAfter(element.parent());
                        },
                        invalidHandler: function (form) {
                        }
                    });
                    var dialog = $( "#edit-tag-container" ).removeClass('hide').dialog({
                        dragStop: function( event, ui ) {
                            $(event.target.offsetParent).css("height", "auto");
                        },
                        resizable: false,
                        width: '600',
                        height: 'auto',
                        modal: true,
                        closeText: "关闭",
                        title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-pencil-square-o'></i>&nbsp;编辑标签</h4></div>",
                        title_html: true,
                        buttons: [
                            {
                                text: "保存",
                                "class" : "btn btn-info btn-minier",
                                click: function() {
                                    var _this = $(this);
                                    var flag = $formEditTag.form();
                                    if(flag){
                                        var data = {
                                            "id": id,
                                            "name": $("#edit-tag-group-name").val()
                                        };
                                        $.ajax({
                                            url: contextPath+"api/labgroup/",
                                            type: "put",
                                            data : JSON.stringify(data),
                                            contentType: "application/json",
                                            dataType : "json",
                                            success: function (data) {
                                                tagRefreshNode();
                                                _this.dialog( "close" );
                                            },
                                            error: function (data) {
//                                                console.log(data);
                                            }
                                        })

                                    }


                                }
                            },
                            {
                                text: "删除",
                                "class" : "btn btn-danger btn-minier ",
                                click: function() {
                                    var _this = $(this);
                                    $.ajax({
                                        url: contextPath+"api/extconlab/?id="+id,
                                        type: "delete",
                                        contentType: "application/json",
                                        dataType : "json",
                                        success: function (data) {
                                            tagRefreshNode();
                                            _this.dialog( "close" );
                                        },
                                        error: function (data) {
//                                            console.log(data);
                                        }
                                    });
                                }
                            },
                            {
                                text: "取消",
                                "class" : "btn btn-minier",
                                click: function() {
                                    $( this ).dialog( "close" );
                                }
                            }
                        ]
                    });
                }


            });

        }
        function tagRemoveHoverDom(treeId, treeNode) {
            $("#diyBtn_"+treeNode.id).unbind().remove();
            $("#diyBtn_space_" +treeNode.id).unbind().remove();
        }
        $.fn.zTree.init($("#tag-list"), tagSettings);

        //新增标签组
        var $formAddTagGroup = $('#add-tag-group-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                tagName: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $(".add-tag-group-btn").on("click", function () {
            validateResetForm($formAddTagGroup, $('#add-tag-group-container>form'));
            var dialog = $( "#add-tag-group-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;新增标签组</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formAddTagGroup.form();
                            if(flag){
                                var data = {
                                    "name": $("#add-tag-group-name").val()
                                };
                                $.ajax({
                                    url: contextPath+"api/labgroup/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        tagRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //新增标签
        var $formAddTag = $('#add-tag-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                tagName: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $(".add-tag-btn").on("click", function () {
            validateResetForm($formAddTag, $('#add-tag-container>form'));
            var dialog = $( "#add-tag-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '600',
                height: 'auto',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;新增标签组</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formAddTag.form();
                            if(flag){
                                var data = {
                                    "gid": $("#add-tag-group").val(),
                                    "name": $("#add-tag-name").val()
                                };
                                $.ajax({
                                    url: contextPath+"api/extconlab/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        tagRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })

                            }


                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //添加外部联系人
        var $formAddOutcontacts = $('#add-outcontacts-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                username: {
                    required: true
                },
                phone: {
                    required: true,
                    /* remote: {
                     url: contextPath+"api/dingtalkuser/mobile",
                     type: "post",               //数据发送方式
                     dataType: "json",           //接受数据格式
                     data: JSON.stringify({                     //要传递的数据
                     mobile: function() {
                     return $("#add-department-staff-phone").val();
                     }
                     })
                     }*/
                },
                addOutcontactsTag: {
                    required: true
                }
            },
            messages: {
                remote: "该用户已经存在"
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        $( ".add-outcontacts-btn" ).on('click', function(e) {
            validateResetForm($formAddOutcontacts, $('#add-outcontacts-container>form'));
            //选择标签
            $.ajax({
                url: contextPath+"api/labgroup/list",
                type: "get",
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    if (data.content.length) {
                        var addOutcontactsTagSelectBox = $("#add-outcontacts-tag-select");
                        addOutcontactsTagSelectBox.html("");
                        $.each(data.content, function (i, item) {
                            var addOutcontactsTagSelectHtml = "", addOutcontactsChildrenTagSelectHtml = "", num = i;
                            $.each(item.children, function (i, item) {
                                addOutcontactsChildrenTagSelectHtml += '<div class="radio inline">' +
                                        '<label>' +
                                        '<input name="form-field-checkbox'+ num +'" type="checkbox" class="ace" value="'+ item.id +'">' +
                                        '<span class="lbl">'+ item.name +'</span>' +
                                        '</label>' +
                                        '</div>';
                            });
                            addOutcontactsTagSelectHtml = '<li>' +
                                    '<div class="control-group" style="">' +
                                    '<label class="control-label bolder blue block align-left">'+ item.name +'</label>' +
                                    addOutcontactsChildrenTagSelectHtml+
                                    '</div>'+
                                    '</li>'
                            addOutcontactsTagSelectBox.append(addOutcontactsTagSelectHtml);
                            $("#add-outcontacts-tag-select>li .control-group input[type=checkbox]").on("click", function () {
                                $(this).parents("div").siblings().find("input").attr("checked", false);

                            });
                        });
                    }
                },
                error: function (data) {
//                    console.log(data);
                }
            });

            //选择负责人
            $.ajax({
                url: contextPath+"api/dingtalkuser/intermediary_id",
                type: "get",
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    if (data.content.length) {
                        var outcontactsPrincipalBox = $("#outcontacts-principal");
                        outcontactsPrincipalBox.html("");
                        $.each(data.content, function (i, item) {
                            var  outcontactsPrincipalHtml = "";
                            outcontactsPrincipalHtml = '<option value="'+ item.userid +'">'+ item.name +'</option>';
                            outcontactsPrincipalBox.append(outcontactsPrincipalHtml);
                        });
                    }
                },
                error: function (data) {
//                    console.log(data);
                }
            });
            $("#add-outcontacts-tag-btn").unbind();
            $("#add-outcontacts-tag-btn").on("click", function () {
                $("#addOutcontactsTag-error").parents(".has-error").removeClass("has-error");
                $("#addOutcontactsTag-error").remove();
                if ($("#add-outcontacts-tag-select").hasClass("display-none")) {
                    $("#add-outcontacts-tag-select").removeClass("display-none")
                } else {
                    $("#add-outcontacts-tag-select").addClass("display-none")
                }
            });

            var dialog = $( "#add-outcontacts-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '680',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;添加成员</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formAddOutcontacts.form(), labsList = $("#add-outcontacts-container .control-group input[type=checkbox]:checked"), arrLabs = [];
                            labsList.each(function (i, item) {
                                arrLabs.push({"id": $(item).val()});
                            });
                            if (labsList.length) {
                                $("#add-outcontacts-tag-btn").siblings("input").val("true");
                                $("#addOutcontactsTag-error").parents(".has-error").removeClass("has-error");
                                $("#addOutcontactsTag-error").remove();
                            } else {
                                $("#add-outcontacts-tag-btn").siblings("input").val("");
                            }
                            if(flag){
                                var data = {
                                    "username": $("#add-outcontacts-username").val(),
                                    "company": $("#add-outcontacts-company").val(),
                                    "pos": $("#add-outcontacts-position").val(),
                                    "email": $("#add-outcontacts-email").val(),
                                    "tel": $("#add-outcontacts-phone").val(),
                                    "adress": $("#add-outcontacts-address").val(),
                                    "charge": $("#outcontacts-principal").val(),
                                    "remark": $("#add-outcontacts-remark").val(),
                                    "labs": arrLabs
                                };
                                $.ajax({
                                    url: contextPath+"api/extcon/",
                                    type: "post",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        tagRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })
                            }
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        });

        //编辑外部联系人
        var $formEditOutcontacts = $('#edit-outcontacts-container>form').validate({
            errorElement: 'span',
            errorClass: 'help-block col-sm-9 col-sm-offset-2 align-left control-label no-padding-right',
            focusInvalid: false,
            ignore: "",
            rules: {
                username: {
                    required: true
                },
                phone: {
                    required: true,
                    /* remote: {
                     url: contextPath+"api/dingtalkuser/mobile",
                     type: "post",               //数据发送方式
                     dataType: "json",           //接受数据格式
                     data: JSON.stringify({                     //要传递的数据
                     mobile: function() {
                     return $("#add-department-staff-phone").val();
                     }
                     })
                     }*/
                },
                editOutcontactsTag: {
                    required: true
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            },
            success: function (e) {
                $(e).closest('.form-group').removeClass('has-error');
                $(e).remove();
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            invalidHandler: function (form) {
            }
        });
        function editOutcontacts(id) {
            validateResetForm($formEditOutcontacts, $('#edit-outcontacts-container>form'));
            $.ajax({
                url: contextPath+"api/extcon/?id="+id,
                type: "get",
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    if (data.content) {
//                        console.log(data);
                        var result = data.content, charge = result.charge, labsObj = result.labs;
                        $("#edit-outcontacts-username").val(result.username);
                        $("#edit-outcontacts-company").val(result.company);
                        $("#edit-outcontacts-position").val(result.pos);
                        $("#edit-outcontacts-email").val(result.email);
                        $("#edit-outcontacts-phone").val(result.tel);
                        $("#edit-outcontacts-address").val(result.adress);
                        $("#edit-outcontacts-remark").val(result.mark);

                        //选择标签
                        $.ajax({
                            url: contextPath+"api/labgroup/list",
                            type: "get",
                            contentType: "application/json",
                            dataType : "json",
                            success: function (data) {
                                if (data.content.length) {
                                    var editOutcontactsTagSelectBox = $("#edit-outcontacts-tag-select");
                                    editOutcontactsTagSelectBox.html("");
                                    $.each(data.content, function (k, ktem) {
                                        var editOutcontactsTagSelectHtml = $('<li><div class="control-group" style=""><label class="control-label bolder blue block align-left"></label></div></li>');
                                        editOutcontactsTagSelectHtml.find('label').text(ktem.name);
                                        editOutcontactsTagSelectBox.append(editOutcontactsTagSelectHtml);


                                        if (ktem.children.length) {
                                            $.each(ktem.children, function (i, item) {
                                                var editOutcontactsChildrenTagSelectHtml = $('<div class="radio inline"><label><input  type="checkbox" class="ace"><span class="lbl"></span></label></div>');
                                                editOutcontactsChildrenTagSelectHtml.find("span.lbl").text(item.name);

                                                editOutcontactsChildrenTagSelectHtml.find("input").attr("name","form-field-checkbox"+i);

                                                editOutcontactsChildrenTagSelectHtml.find("input").attr("value",item.id);

                                                editOutcontactsTagSelectHtml.find("div.control-group").append(editOutcontactsChildrenTagSelectHtml);
                                                if (labsObj.length) {
                                                    $.each(labsObj,function (j, jtem) {
                                                        if (item.id == jtem.id) {
                                                            editOutcontactsChildrenTagSelectHtml.find("input[type=checkbox]").attr("checked",true);
                                                        }
                                                    });
                                                }
                                            });

                                        }
                                        $("#edit-outcontacts-tag-select>li .control-group input[type=checkbox]").on("click", function () {
                                            $(this).parents("div").siblings().find("input").attr("checked", false);

                                        });
                                    });
                                }
                            },
                            error: function (data) {
//                                console.log(data);
                            }
                        });
                        //选择负责人
                        $.ajax({
                            url: contextPath+"api/dingtalkuser/intermediary_id",
                            type: "get",
                            contentType: "application/json",
                            dataType : "json",
                            success: function (data) {
                                if (data.content.length) {
                                    var editOutcontactsPrincipalBox = $("#edit-outcontacts-principal");
                                    editOutcontactsPrincipalBox.html("");
                                    $.each(data.content, function (i, item) {
                                        var editOutcontactsPrincipalHtml = "";
                                        if (item.userid == charge) {
                                            editOutcontactsPrincipalHtml = '<option value="'+ item.userid +'" selected>'+ item.name +'</option>';
                                            editOutcontactsPrincipalBox.append(editOutcontactsPrincipalHtml);
                                        } else {
                                            editOutcontactsPrincipalHtml = '<option value="'+ item.userid +'">'+ item.name +'</option>';
                                            editOutcontactsPrincipalBox.append(editOutcontactsPrincipalHtml);
                                        }

                                    });
                                }
                            },
                            error: function (data) {
//                                console.log(data);
                            }
                        });
                    }
                },
                error: function (data) {
//                    console.log(data);
                }
            });

            $("#edit-outcontacts-tag-btn").unbind();
            $("#edit-outcontacts-tag-btn").on("click", function () {
                $("#editOutcontactsTag-error").parents(".has-error").removeClass("has-error");
                $("#editOutcontactsTag-error").remove();
                if ($("#edit-outcontacts-tag-select").hasClass("display-none")) {
                    $("#edit-outcontacts-tag-select").removeClass("display-none")
                } else {
                    $("#edit-outcontacts-tag-select").addClass("display-none")
                }
            });

            var dialog = $( "#edit-outcontacts-container" ).removeClass('hide').dialog({
                dragStop: function( event, ui ) {
                    $(event.target.offsetParent).css("height", "auto");
                },
                resizable: false,
                width: '680',
                modal: true,
                closeText: "关闭",
                title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-plus'></i>&nbsp;添加成员</h4></div>",
                title_html: true,
                buttons: [
                    {
                        text: "保存",
                        "class" : "btn btn-info btn-minier",
                        click: function() {
                            var _this = $(this);
                            var flag = $formEditOutcontacts.form(), labsList = $("#edit-outcontacts-container .control-group input[type=checkbox]:checked"), arrLabs = [];
                            labsList.each(function (i, item) {
                                arrLabs.push({"id": $(item).val()});
                            });
                            if (labsList.length) {
                                $("#edit-outcontacts-tag-btn").siblings("input").val("true");
                                $("#editOutcontactsTag-error").parents(".has-error").removeClass("has-error");
                                $("#editOutcontactsTag-error").remove();
                            } else {
                                $("#edit-outcontacts-tag-btn").siblings("input").val("");
                            }
                            if(flag){
                                var data = {
                                    "id": id,
                                    "username": $("#edit-outcontacts-username").val(),
                                    "company": $("#edit-outcontacts-company").val(),
                                    "pos": $("#edit-outcontacts-position").val(),
                                    "email": $("#edit-outcontacts-email").val(),
                                    "tel": $("#edit-outcontacts-phone").val(),
                                    "adress": $("#edit-outcontacts-address").val(),
                                    "charge": $("#edit-outcontacts-principal").val(),
                                    "remark": $("#edit-outcontacts-remark").val(),
                                    "labs": arrLabs
                                };
//                                console.log(data);
//                                return;
                                $.ajax({
                                    url: contextPath+"api/extcon/",
                                    type: "put",
                                    data : JSON.stringify(data),
                                    contentType: "application/json",
                                    dataType : "json",
                                    success: function (data) {
                                        tagRefreshNode();
                                        _this.dialog( "close" );
                                    },
                                    error: function (data) {
//                                        console.log(data);
                                    }
                                })
                            }
                        }
                    },
                    {
                        text: "删除",
                        "class" : "btn btn-danger btn-minier ",
                        click: function() {
                            var _this = $(this);
                            $.ajax({
                                url: contextPath+"api/extcon/?id="+id,
                                type: "delete",
                                contentType: "application/json",
                                dataType : "json",
                                success: function (data) {
                                    $.ajax({
                                        async : false,
                                        cache:false,
                                        type: 'get',
                                        dataType : "json",
                                        contentType: "application/json",
                                        url: contextPath + "api/extcon/labid?labid="+$(".outcontacts-container").attr("data-labid"),
                                        success:function(data){
                                            if (data.status == "200") {
                                                //人员列表
                                                $("#outcontacts-list>tbody").html('');
                                                if (data.content.length) {
                                                    var outcontactsListHtml = '';
                                                    $.each(data.content, function (i, item) {
                                                        outcontactsListHtml += '<tr class="align-center">'+
                                                                '<td>'+
                                                                '<label class="pos-rel">'+
                                                                '<input type="checkbox" class="ace" data-id="'+ item.id +'">'+
                                                                '<span class="lbl"></span>'+
                                                                '</label>'+
                                                                '</td>'+
                                                                '<td>'+ item.username +'</td>'+
                                                                '<td>'+ item.tel +'</td>'+
                                                                '<td>'+ item.company +'</td>'+
                                                                '<td>'+ item.changeUser.name +'</td>'+
                                                                '<td data-id="'+ item.id +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-outcontacts-btn" title="编辑信息"></i></td>'+
                                                                '</tr>';
                                                    });
                                                } else {
                                                    outcontactsListHtml = '<tr><td colspan="6">'+
                                                            '<div class="alert alert-info">'+
                                                            '<button type="button" class="close" data-dismiss="alert">'+
                                                            '<i class="ace-icon fa fa-times"></i>'+
                                                            '</button>'+
                                                            '当前暂无人员请添加成员'+
                                                            '</div>'+
                                                            '</td>' +
                                                            '</tr>';
                                                }
                                                $("#outcontacts-list>tbody").append(outcontactsListHtml);

                                                //编辑外部联系人
                                                $(".edit-outcontacts-btn").on("click", function () {
                                                    editOutcontacts($(this).parent().attr("data-id"));
                                                });
                                            }
                                        },
                                        error: function () {
//                                            alert('请求失败');
                                        }
                                    });
                                    _this.dialog( "close" );
                                },
                                error: function (data) {
//                                    console.log(data);
                                }
                            });
                        }
                    },
                    {
                        text: "取消",
                        "class" : "btn btn-minier",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });
        }

        //删除外部联系人
        $(".outcontacts-list-head .checkbox-all").on("click", function () {
            var outcontactsListBodyTr = $(".outcontacts-list-body tr");
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
                outcontactsListBodyTr.find("td input[type=checkbox]").prop('checked', false)
            } else {
                $(this).addClass("active");
                outcontactsListBodyTr.find("td input[type=checkbox]:not(:disabled)").prop('checked', true)
            }
        });
        $(".del-outcontacts-btn").on("click", function () {
            var selectBoxlist = $(".outcontacts-list-body input:checkbox:checked"), data = [];
            if (selectBoxlist.length) {
                selectBoxlist.each(function (i, item) {
                    if (!$(item).attr("disabled")) {
                        data.push($(item).attr("data-id"))
                    }
                })
            }
            $.ajax({
                url: contextPath+"api/extcon/batch",
                type: "delete",
                data : JSON.stringify(data),
                contentType: "application/json",
                dataType : "json",
                success: function (data) {
                    $.ajax({
                        async : false,
                        cache:false,
                        type: 'get',
                        dataType : "json",
                        contentType: "application/json",
                        url: contextPath + "api/extcon/labid?labid="+$(".outcontacts-container").attr("data-labid"),
                        success:function(data){
                            if (data.status == "200") {
                                //人员列表
                                $("#outcontacts-list>tbody").html('');
                                if (data.content.length) {
                                    var outcontactsListHtml = '';
                                    $.each(data.content, function (i, item) {
                                        outcontactsListHtml += '<tr class="align-center">'+
                                                '<td>'+
                                                '<label class="pos-rel">'+
                                                '<input type="checkbox" class="ace" data-id="'+ item.id +'">'+
                                                '<span class="lbl"></span>'+
                                                '</label>'+
                                                '</td>'+
                                                '<td>'+ item.username +'</td>'+
                                                '<td>'+ item.tel +'</td>'+
                                                '<td>'+ item.company +'</td>'+
                                                '<td>'+ item.changeUser.name +'</td>'+
                                                '<td data-id="'+ item.id +'"><i class="ace-icon fa fa-pencil-square-o bigger-110 icon-only edit-outcontacts-btn" title="编辑信息"></i></td>'+
                                                '</tr>';
                                    });
                                } else {
                                    outcontactsListHtml = '<tr><td colspan="6">'+
                                            '<div class="alert alert-info">'+
                                            '<button type="button" class="close" data-dismiss="alert">'+
                                            '<i class="ace-icon fa fa-times"></i>'+
                                            '</button>'+
                                            '当前暂无人员请添加成员'+
                                            '</div>'+
                                            '</td>' +
                                            '</tr>';
                                }
                                $("#outcontacts-list>tbody").append(outcontactsListHtml);

                                //编辑外部联系人
                                $(".edit-outcontacts-btn").on("click", function () {
                                    editOutcontacts($(this).parent().attr("data-id"));
                                });
                            }
                        },
                        error: function () {
//                            alert('请求失败');
                        }
                    });
                },
                error: function (data) {
//                    budata);
                }
            })
        });
    });
</script>
</body>
</html>
