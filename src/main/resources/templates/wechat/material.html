<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <link rel="stylesheet" th:href="@{/dist/css/gzh-l/webuploader.css}"/>
    <link rel="stylesheet" th:href="@{/dist/css/gzh-l/gzh-common.css}"/>
    <link rel="stylesheet" th:href="@{/dist/css/gzh-l/wx-audio.css}"/>
    <style>
        body{
            overflow-x: hidden;
        }
        .gzh-source-type{
            margin-top: 4%;
            height: 32px;
            line-height: 32px;
            width: 100%;
            margin-left: 16px;
            /*background: #F5F5F5;*/

        }
        .gzh-source-type a{
            font-size: 16px;
            color: #626262;
            cursor: pointer;
            width: 100px;
            display: inline-block;
           text-align: center;
            border: 1px #c7c7c7 solid;
            border-bottom: none;
            background: #F5F5F5;
        }
        .gzh-source-type a:hover{
            text-decoration: none;
        }
        .tex-bgcolor {
            color: #1d1d1d !important;
            display: inline-block;
            background: #ffffff!important;
            font-weight: 500;
            border-top: 2px #6FB3E0 solid!important;
        }
        .bor-top{
            border-top: 2px #c7c7c7 solid;
            margin-top: 1.1px;
            margin-left: 16px;
        }
        .newPhotoText span{
            display: inline-block;
            cursor: pointer;
            width: 100%;
            height: 50px;
            line-height:50px;
            text-align: center;
            border: 1px #bcbcbc solid;
            color: #818181;
            font-size: 14px;
        }
        .newPhotoText i{
            padding-right: 10px;
            font-size: 18px;
            color: #818181;
            margin-top: 5px;
        }
        #topCheck{
            width: 100%;
            margin-top: 35px;
            height: 50px;
            line-height: 50px;
            border-left: 1px #1794e4 solid;
            border-right: 1px #1794e4 solid;
            text-align: center;
            cursor: pointer;
            margin-bottom: -20px;
            background: #1794e4;
            color: #ffffff;
            font-size: 16px;
        }
        #photoTop img{
            margin-top: 30px;
        }
        .addInp{
            width: 90%;
            margin-left: 5%;
            height: 40px;
            line-height: 40px;
            margin-top: 30px;
            border: none!important;
        }
        #editInputAutor{
            border-bottom: 1px #e5e5e5 solid!important;
        }
        .contentP{
            height: 125px;
        }
        .cke_bottom{
            background: none!important;
            border-top: none!important;
        }
        .webuploader-pick{
            height: 32px;
            line-height: 32px;
            padding: 0 0;
            display: block;
            background:#1794e4!important;
        }
        #filePicker{
            width: 120px;
            height: 32px;
            background: #1794e4;
            text-align: center;
            line-height: 32px;
            color: #FFFFFF;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 15px;
        }
        .btnBG{
            background: #1794e4;!important;
            margin-right: 15px;
        }
        #photo-tx{
            height: 530px;
            border: 1px #e0e0e0 solid;
            margin-top: 1%;
            width: 99%;
            margin-left: 1%;
            overflow: auto;
        }
        .source-title{
            margin-top: 15px;
            margin-left: 20px;
            border-bottom: 2px #eee solid;
            height: 32px;
            font-size: 16px;
        }
        textarea::-webkit-input-placeholder{
            color:#c2c2c2;
        }
    </style>
</head>
<body layout:fragment="content">

<div class="row">
    <div id="gzh-manage">
        <section class="content-header gzh-manage-menu">
            <a class="font-size-14" data-id="1">用户管理</a>
            <a class="font-size-14" data-id="2">菜单管理</a>
            <a class="font-size-14" data-id="3">消息管理</a>
            <a class="font-size-14 tex-color" data-id="4">素材管理</a>
            <button class="btn btn-info search text-center pull-right" id="backUl" title="返回"><i class="ace-icon fa fa-reply icon-only"></i>返回</button>
        </section>
        <div style="margin-top:-2%;width: 100%;height: auto;font-size: 13px;">
            <div class="content-header gzh-source-type">
                <a class="" data-id="1" style="border-right: none;">图文消息</a><a class="" data-id="2" style="border-right: none;">图片</a><a class="" data-id="3" style="border-right: none;">语音</a><a class="" data-id="4">视频</a>
                <div style="width: 120px;height: 30px;float: right;">
                    <div id="filePicker">新建图文信息</div>
                    <div id="filePicker1" class="btnBG" style="display: none;">上传图片</div>
                    <div id="filePicker2" class="btnBG" style="display: none;">添加语音</div>
                    <div id="filePicker3" class="btnBG" style="display: none;">添加视频</div>
                </div>
            </div>
            <div class="bor-top"></div>
            <div style="margin-top: 1%;">
                <span style="margin-left: 2%"><a class="new-type-name">图文消息</a><a>（共<span id="NumMater"></span>条）</a></span>
            </div>
            <!--素材库图文消息内容-->
            <div>
                <div id="photo-tx">
                    <ul class="messageUl" style="height: auto;">
                        <!--<li class="messageLi">-->
                            <!--<div>-->
                                <!--<p>标题：</p>-->
                                <!--<p>作者：</p>-->
                                <!--<p>文章摘要：</p>-->
                                <!--<p>内容：</p>-->
                            <!--</div>-->
                        <!--</li>-->
                    </ul>
                    <div id="pagingTest3" class="pageIndex pagingTest" style="position: absolute;bottom: -20px;"></div>
                </div>
                <!--图片-->
                <div id="photo-show" style="height: 530px;border: 1px #e0e0e0 solid;margin-top: 1%;width: 99%;margin-left: 1%;display: none;overflow: auto;">
                    <ul id="imgShow" class="imgShow"></ul>
                    <div id="pagingTest" class="pageIndex pagingTest" style="position: absolute;bottom: -20px;"></div>
                    <!--<input type="hidden" value="" id="page">-->
                </div>
                <!--语音-->
                <div id="source" style="height: 530px;border: 1px #e0e0e0 solid;margin-top: 1%;width: 99%;margin-left: 1%;display: none;overflow: auto;">
                    <ul id="mpShow" class=""></ul>
                    <div id="pagingTest1" class="pageIndex pagingTest" style="position: absolute;bottom: -20px;"></div>
                    <!--<input type="hidden" value="" id="page1">-->
                </div>
                <!--视频-->
                <div id="vid" style="height: 530px;border: 1px #e0e0e0 solid;margin-top: 1%;width: 99%;margin-left: 1%;display: none;overflow: auto;">
                    <ul id="vidShow"></ul>
                    <div id="pagingTest2" class="pageIndex pagingTest" style="position: absolute;bottom: -20px;"></div>
                    <!--<input type="hidden" value="" id="page2">-->
                </div>
            </div>
        </div>
    </div>
    <!--新建图文素材-->
    <div id="new-photo-text" style="display: none;">
        <div class="source-title">新建图文消息</div>
        <button class="btn btn-info search text-center pull-right" id="backStore" style="margin-right: 35px;margin-top: -45px;height: 38px;" title="返回"><i class="ace-icon fa fa-reply icon-only"></i>返回</button>
        <div style="margin-left: 1%;margin-top:2%;width: 98%;height: 650px;">
            <section class="float-left" style="width: 70%;height: 100%;">
                <div>
                      <textarea name="editor1" id="editor1" style="resize: none;">

                      </textarea>
                      <textarea placeholder="请输入文章摘要" class="col-xs-12"  rows="3" style="resize: none;" id="autorAbout"></textarea>
                      <input type="text" placeholder="请输入原文链接,以http://开头" class="col-xs-12" id="tpUrl">
                </div>
                <div style="width: 72px;height: 35px;line-height:38px;cursor:pointer;text-align:center;display: block;margin-top: 15px;float: right;background: #1794e4;color: #ffffff;height: 38px;" id="savapt">保存</div>
                <label id="errorMsg" style="margin-top: 26px;float: right;margin-right: 20px;"></label>
            </section>
            <section class="float-left" style="width: 25%;margin-left: 2.5%;border-left: 1px #E5E5E5 solid;border-right: 1px #E5E5E5 solid;">
                <label style="width:100%;text-align: center;background: #E5E5E5;height: 40px;line-height: 40px;color: #1794e4;" class="text-center;">多媒体选择</label>
                <div style="width: 80%;margin-left: 10%;margin-top: 10px;" class="newPhotoText">
                    <span style="margin-top: 10px;" data-id="1" title="导入图片"><i class="glyphicon glyphicon-picture"></i>导入图片</span>
                    <span style="margin-top: 20px;" data-id="2" title="导入视频"><i class="glyphicon glyphicon-hd-video"></i>导入视频</span>
                    <span style="margin-top: 20px;" data-id="3" title="导入音频"><i class="glyphicon glyphicon-ice-lolly"></i>导入音频</span>
                </div>
                <div id="topCheck" title="选择图文封面">选择图文封面</div>
                <div id="photoTop" style="text-align: center;"></div>
            </section>
        </div>
    </div>
    <!--素材库弹窗-->
    <div class="modal" id="sourceRoom" tabindex="-1" role="dialog" aria-labelledby="mySource" style="position: absolute;top:8%;">
        <div class="modal-dialog" role="document" style="width: 50%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-left" id="mySource"></h4>
                </div>
                <div class="modal-body" style="min-height: 400px;height: 450px;overflow: auto;">
                    <ul id="popImg" class="imgShow"></ul>
                    <div id="popPagingTest" class="pageIndex pagingTest"></div>
                    <div id="popPagingmp3" class="pageIndex pagingTest"></div>
                    <div id="popPagingmp4" class="pageIndex pagingTest"></div>
                    <!--<input type="hidden" value="" id="popPage">-->
                </div>
                <div class="modal-footer">
                    <button type="button" id="btn-sure-source" class=" text-center btnStyle" title="确定">确定</button>
                    <button type="button" id="btn-cancel-source" class=" text-center btnStyle" data-dismiss="modal" title="取消">取消</button>
                </div>
            </div>
        </div>
    </div>
    <!--单个图文弹窗-->
    <div class="modal" id="aphoto" tabindex="-1" role="dialog" aria-labelledby="mySourcePhoto" style="position: absolute;top:8%;">
        <div class="modal-dialog" role="document" style="width: 50%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-left" id="mySourcePhoto"></h4>
                </div>
                <div class="modal-body" style="min-height: 400px;height: 450px;overflow: auto;">
                   <div id="photoAutor"><span></span><span></span><span style="margin-left: 10px;"></span></div>
                   <div id="photoContent" style="margin-top: 15px;"> </div>
                   <a id="photoUrl" style="margin-top: 15px;" href="" target="_blank">阅读原文</a>
                </div>


            </div>
        </div>
    </div>
</div>
<script th:src="@{/dist/js/gzh/gzh-common.js}"></script>
<script th:src="@{/dist/js/gzh/webuploader.js}"></script>
<script th:src="@{/dist/js/gzh/upload.js}"></script>
<script th:src="@{/dist/js/gzh/hand-paging.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var wxPublicId = /*[[${wxPublicId}]]*/;
    /*]]>*/
    $(function () {
        //从外部获取该相应的菜单
        function getUrlParms(name){
            var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r!=null)
                return unescape(r[2]);
            return null;
        }
        var id = getUrlParms("id");
        if(id==null){
            $(".gzh-source-type>a:eq(0)").addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
            $(".new-type-name").text("图文消息");
            $("#filePicker").show().siblings().hide();
            $("#photo-tx").show().siblings().hide();
            photoText(1);
        }else if(id==1){
            $(".gzh-source-type>a:eq(0)").addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
            $(".gzh-source-type>a:eq(0)").addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
            $(".new-type-name").text("图文消息");
            $("#filePicker").show().siblings().hide();
            $("#photo-tx").show().siblings().hide();
            photoText(1);
        }else if(id==2){
            $(".gzh-source-type>a:eq(1)").addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
            $(".new-type-name").text("图片");
            $("#filePicker1").show().siblings().hide();
            $("#photo-show").show().siblings().hide();
            ajaxData(1);
        }else if(id==3){
            $(".gzh-source-type>a:eq(2)").addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
            $(".new-type-name").text("语音");
            $("#filePicker2").show().siblings().hide();
            $("#source").show().siblings().hide();
            ajaxMp(1);
        }else if(id==4){
            $(".gzh-source-type>a:eq(3)").addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
            $(".new-type-name").text("视频");
            $("#filePicker3").show().siblings().hide();
            $("#vid").show().siblings().hide();
            ajaxVid(1);
        }
        //菜单选中
        $(document).on("click",".gzh-source-type>a",function () {
            $(this).addClass("tex-bgcolor").siblings().removeClass("tex-bgcolor");
        });
       //上传bug
        setTimeout(function(){
            $(".webuploader-pick").next().css({
                position: "absolute",
                top: "0px",
                left: "15px",
                width: "85px",
                height: "40px",
                overflow: "hidden",
                opacity: 0
            });
        }, 1000);
        //点击tab页面切换功能
        $(".gzh-source-type a").click(function () {
            var cliID=$(this).attr("data-id");
            $(this).addClass("cli-color").siblings().removeClass("cli-color");
            if(cliID=="1"){
                $(".new-type-name").text("图文消息");
                $("#filePicker").show().siblings().hide();
                $("#photo-tx").show().siblings().hide();
                photoText(1);
            } else if(cliID=="2"){
                $(".new-type-name").text("图片");
                $("#filePicker1").show().siblings().hide();
                $("#photo-show").show().siblings().hide();
                ajaxData(1);
            } else if(cliID=="3"){
                $(".new-type-name").text("语音");
                $("#filePicker2").show().siblings().hide();
                $("#source").show().siblings().hide();
                ajaxMp(1);
            } else if(cliID=="4"){
                $(".new-type-name").text("视频");
                $("#filePicker3").show().siblings().hide();
                $("#vid").show().siblings().hide();
                ajaxVid(1);
            }
        })
        //新建素材页面
        $(document).on("click","#filePicker",function () {
           $("#new-photo-text").show().siblings().hide();
        });
        //文本编辑器
        var editor;
        CKEDITOR.replace( 'editor1',{
             height:250,
            toolbarGroups: [
                {"name":"basicstyles","groups":["basicstyles"]},
                {"name":"links","groups":["links"]},
                {"name":"paragraph","groups":["list","blocks"]},
//            {"name":"document","groups":["mode"]},
                {"name":"insert","groups":["insert"]},
                //{"name":"styles","groups":["styles"]},
//            {"name":"about","groups":["about"]}
            ]
        });
        CKEDITOR.on( 'instanceReady', function (ev) {
            editor = ev.editor;
            var title = '<input type="text" id="editInputTitle" class="addInp" placeholder="请输入标题" style="font-size: 20px;">' +
                '<input type="text" id="editInputAutor" class="addInp" placeholder="请输入作者" >';
            $("#cke_1_contents").before(title);
            $(".addInp").on('focus',function(){
                editor.setReadOnly( true );
            })
            $(".addInp").on('blur',function(){
                editor.setReadOnly( false );
            })
            var editor1 = CKEDITOR.instances.editor1;
            editor1.focus();
        });



        //新建素材返回菜单
        $(document).on("click","#backStore",function () {
            $("#gzh-manage").show().siblings().hide();
        })
        //多媒体选中newPhotoText
        $(document).on("click",".newPhotoText>span",function () {
            var thisId=$(this).attr("data-id");
            $('#sourceRoom').modal();
            if(thisId==1){
                $("#popPagingTest").show();
                $("#popPagingmp3").hide();
                $("#popPagingmp4").hide();
                $("#btn-sure-source").attr("data-id",1);
                $("#mySource").text("选择图片");
                ajaxDataPop(1);
            }
            if(thisId==2){
                $("#popPagingTest").hide();
                $("#popPagingmp3").hide();
                $("#popPagingmp4").show();
                $("#btn-sure-source").attr("data-id",2);
                $("#mySource").text("选择视频");
                ajaxVidPop(1);
            }
            if (thisId==3){
                $("#popPagingTest").hide();
                $("#popPagingmp3").show();
                $("#popPagingmp4").hide();
                $("#btn-sure-source").attr("data-id",3);
                $("#mySource").text("选择音频");
                ajaxMpPop(1);
            }
        });
        //图片选中
        var thisSrc;
        var thisphotoId;
        var thisYsrc;
        var thisYId;
        var thisVsrc;
        var thisVId;
        $(document).on("click","#popImg li img",function () {
            thisSrc=$(this).attr("src");
            thisphotoId=$(this).attr("data-id");
            $(this).addClass("opactiy").parent().siblings().children().removeClass("opactiy");
            $(this).parent().append("<a class='bgimg'></a>").siblings().children("a").remove();
        });
        //音频选中
        $(document).on("click","#popImg li audio",function () {
            thisYsrc=$(this).attr("data-src");
            thisYId=$(this).attr("data-id");
            $(this).addClass("opactiy").parent().siblings().children().removeClass("opactiy");
            $(this).parent().append("<a class='bgimg'></a>").siblings().children("a").remove();
        });
        //视频选中
        $(document).on("click","#popImg li video",function () {
            thisVsrc=$(this).attr("src");
            thisVId=$(this).attr("data-id");
            $(this).addClass("opactiy").parent().siblings().children().removeClass("opactiy");
            $(this).parent().append("<a class='bgimg'></a>").siblings().children("a").remove();
        });
        //封面选择
         $(document).on("click","#topCheck",function () {
             $('#sourceRoom').modal();
             ajaxDataPop(1);
             $("#btn-sure-source").attr("data-id",0);
         })
        //选择多媒体确定
        $(document).on("click","#btn-sure-source",function () {
            var thisId=$(this).attr("data-id");
            $('#sourceRoom').modal("hide");
            var oEditor = CKEDITOR.instances.editor1;
            if(thisId==0){
                var title = '<img style="width:200px;height:150px;" src='+thisSrc+' data-id='+thisphotoId+'>';
                $("#photoTop").empty().append(title)
            }
            if(thisId==1){
                var title1 = '<p><img style="width:200px;height:150px;" src='+thisSrc+'></p>';
                oEditor.insertHtml(title1);
            }
            if(thisId==2){
                var url = thisVsrc;
                var video = editor.document.createElement( 'video' );
                video.setAttribute('src', url);
                video.setAttribute('width', 200);
                video.setAttribute('height', 150);
                video.setAttribute('controls', 'controls');
                editor.insertElement( video );
            }
            if(thisId==3){
                var url = thisYsrc;
                var video = editor.document.createElement( 'video' );
                video.setAttribute('src', url);
                video.setAttribute('width', 200);
                video.setAttribute('height', 50);
                video.setAttribute('controls', 'controls');
                editor.insertElement( video );
            }
        })
        //保存图文信息
        $(document).on("click","#savapt",function () {
            var photoID=$("#photoTop>img").attr("data-id");
            var CHtml= CKEDITOR.instances.editor1.getData();
            var title=$("#editInputTitle").val();
            var autor=$("#editInputAutor").val();
            var zaiyao=$("#autorAbout").val();
            var url=$("#tpUrl").val();
            var Expression=/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;//验证url
            var objExp=new RegExp(Expression);
            if(title==""){
                $("#errorMsg").show().text("请输入图文标题").css("color","red").fadeOut(2000);
                return false;
            } else if(title.length>64){
                $("#errorMsg").show().text("标题不能大于64个字符").css("color","red").fadeOut(2000);
                return false;
            } else if(autor==""){
                $("#errorMsg").show().text("请输入作者").css("color","red").fadeOut(2000);
                return false;
            }else if(autor.length>8){
                $("#errorMsg").show().text("作者不能大于8个字符").css("color","red").fadeOut(2000);
                return false;
            } else if(CHtml==""){
                $("#errorMsg").show().text("请输入正文内容").css("color","red").fadeOut(2000);
                return false;
            }else if(zaiyao==""){
                $("#errorMsg").show().text("请输入图文摘要").css("color","red").fadeOut(2000);
                return false;
            }else if(zaiyao.length>120){
                $("#errorMsg").show().text("摘要不能大于120个字符").css("color","red").fadeOut(2000);
                return false;
            } else if(photoID==undefined){
                $("#errorMsg").show().text("请选中图文封面").css("color","red").fadeOut(2000);
                return false;
            }else if(url==""){
                $("#errorMsg").show().text("请输入原文链接").css("color","red").fadeOut(2000);
                return false;
            }else if(objExp.test(url) != true){
                $("#errorMsg").show().text("请输入正确的链接").css("color","red").fadeOut(2000);
                return false;
            }else{
                var webdata={"title":title,"wxPublicId":wxPublicId,"thumb_media_id":photoID,"author":autor,"show_cover_pic":1,"content":CHtml,"digest":zaiyao,"content_source_url":url};
                $.ajax({
                    url:contextPath +"material/upload/news",
                    type: "POST",
                    //dataType:"json",
                    contentType:'application/json; charset=utf-8',
                    processData:true,
                    data: JSON.stringify(webdata),
                    success:function(data){
                        if (data.content.status==500){
                            alert(data.content.messages)
                        }else if(data.content.status==200){
                            // alert(data.content.messages);
                            $("#new-photo-text").hide();
                            $("#gzh-manage").show();
                            photoText(1)
                        }else {
                            alert("保存失败");
                        }
                    },
                    error:function (data) {
                        alert(data.status);
                    }
                });
            }
        });
        //单个图文悬浮效果
        $(document).on("mouseenter",".messageLi",function () {
            $(this).append("<a class='bgshadow'>预览文章</a>").siblings().find("a").remove();
        });
        $(document).on("mouseleave",".messageLi",function () {
            $(this).find("a").remove();
        });
//单个图文点击跳转
        $(document).on("click",".messageLi",function () {
            var thistwID=$(this).attr("data-id");
            $.ajax({
                url: contextPath +"material/news/detail?wxPublicId="+wxPublicId+"&materialId="+thistwID,
                type: "get",
                processData:true,
                success:function (data) {
                    $('#aphoto').modal();
                    $("#mySourcePhoto").text(data.content.title);
                    $("#photoAutor>span:eq(0)").text(data.content.author);
                    $("#photoAutor>span:eq(2)").text(data.content.updateTime);
                    $("#photoContent").html(data.content.content)
                    $("#photoUrl").attr("href",data.content.contentSourceUrl);
                }
            })


        });





    })
</script>

</body>

</html>